<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.26" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.178" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>Lucky搭配Cloudflare穿透内网实践 | Mayee</title><meta name="description" content="Mayee 的笔记"><link rel="preload" href="/assets/style-KnDcgoSQ.css" as="style"><link rel="stylesheet" href="/assets/style-KnDcgoSQ.css"><link rel="modulepreload" href="/assets/app-B_sKV6fk.js"><link rel="modulepreload" href="/assets/index.html-B8FxtiXW.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-dd2ea341><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-99de49af></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-99de49af> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-dd2ea341 data-v-cbd59ece><div class="vp-navbar" vp-navbar data-v-cbd59ece data-v-00b38fa1><div class="wrapper" data-v-00b38fa1><div class="container" data-v-00b38fa1><div class="title" data-v-00b38fa1><div class="vp-navbar-title" data-v-00b38fa1 data-v-cd71b5f0><a class="vp-link link no-icon title" href="/" data-v-cd71b5f0><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-241acfce><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-241acfce><!--]--><!--]--><!--]--><span data-v-cd71b5f0>Mayee</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-00b38fa1><div class="content-body" data-v-00b38fa1><!--[--><!--]--><div class="vp-navbar-search search" data-v-00b38fa1><div class="search-wrapper" data-v-86f05120><!----><div id="local-search" data-v-86f05120><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-86f05120><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-00b38fa1 data-v-56ee30cd><span id="main-nav-aria-label" class="visually-hidden" data-v-56ee30cd>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-56ee30cd data-v-e5935568><!--[--><!----><span data-v-e5935568>首页</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-56ee30cd data-v-e5935568><!--[--><!----><span data-v-e5935568>博客</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/article/categories/" tabindex="0" data-v-56ee30cd data-v-e5935568><!--[--><!----><span data-v-e5935568>分类</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/article/tags/" tabindex="0" data-v-56ee30cd data-v-e5935568><!--[--><!----><span data-v-e5935568>标签</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/article/archives/" tabindex="0" data-v-56ee30cd data-v-e5935568><!--[--><!----><span data-v-e5935568>归档</span><!----><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-56ee30cd data-v-212729cc><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-212729cc><span class="text" data-v-212729cc><!----><!----><span data-v-212729cc>笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-212729cc></span></span></button><div class="menu" data-v-212729cc><div class="vp-menu" data-v-212729cc data-v-f7ab74ab><div class="items" data-v-f7ab74ab><!--[--><!--[--><div class="vp-menu-link" data-v-f7ab74ab data-v-d3958394><a class="vp-link link" href="/notes/10fywd94/" data-v-d3958394><!--[--><!----> 随手记 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-f7ab74ab data-v-d3958394><a class="vp-link link" href="/notes/qr0e6712/" data-v-d3958394><!--[--><!----> Docker <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-f7ab74ab data-v-d3958394><a class="vp-link link" href="/notes/q5w629t0/" data-v-d3958394><!--[--><!----> KMS <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-f7ab74ab data-v-d3958394><a class="vp-link link" href="/notes/vej2ba8o/" data-v-d3958394><!--[--><!----> 开发环境 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-f7ab74ab data-v-d3958394><a class="vp-link link" href="/command/" data-v-d3958394><!--[--><!----> 常用命令 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-f7ab74ab data-v-d3958394><a class="vp-link link" href="/interview/" data-v-d3958394><!--[--><!----> 面试指南 <!----><!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-00b38fa1 data-v-9942ed5a><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-9942ed5a data-v-9be4d56f data-v-ed16d483><span class="check" data-v-ed16d483><span class="icon" data-v-ed16d483><!--[--><span class="vpi-sun sun" data-v-9be4d56f></span><span class="vpi-moon moon" data-v-9be4d56f></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-00b38fa1 data-v-b1d2f84c data-v-c9db0fe8><!--[--><a class="vp-social-link no-icon" href="https://github.com/mayeona" aria-label="github" target="_blank" rel="noopener" data-v-c9db0fe8 data-v-bdde1d39><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-00b38fa1 data-v-155bedae data-v-212729cc><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-212729cc><span class="vpi-more-horizontal icon" data-v-212729cc></span></button><div class="menu" data-v-212729cc><div class="vp-menu" data-v-212729cc data-v-f7ab74ab><!----><!--[--><!--[--><!----><div class="group" data-v-155bedae><div class="item appearance" data-v-155bedae><p class="label" data-v-155bedae>外观</p><div class="appearance-action" data-v-155bedae><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-155bedae data-v-9be4d56f data-v-ed16d483><span class="check" data-v-ed16d483><span class="icon" data-v-ed16d483><!--[--><span class="vpi-sun sun" data-v-9be4d56f></span><span class="vpi-moon moon" data-v-9be4d56f></span><!--]--></span></span></button></div></div></div><div class="group" data-v-155bedae><div class="item social-links" data-v-155bedae><div class="vp-social-links social-links-list" data-v-155bedae data-v-c9db0fe8><!--[--><a class="vp-social-link no-icon" href="https://github.com/mayeona" aria-label="github" target="_blank" rel="noopener" data-v-c9db0fe8 data-v-bdde1d39><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-00b38fa1 data-v-a432f868><span class="container" data-v-a432f868><span class="top" data-v-a432f868></span><span class="middle" data-v-a432f868></span><span class="bottom" data-v-a432f868></span></span></button></div></div></div></div><div class="divider" data-v-00b38fa1><div class="divider-line" data-v-00b38fa1></div></div></div><!----></header><!----><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-dd2ea341 data-v-631f6a1b><div class="vp-doc-container is-posts" data-v-631f6a1b data-v-5e118bb0><!--[--><!--]--><div class="container" data-v-5e118bb0><!----><div class="content" data-v-5e118bb0><div class="content-container" data-v-5e118bb0><!--[--><!--]--><main class="main" data-v-5e118bb0><nav class="vp-breadcrumb" data-v-5e118bb0 data-v-4d9bdc00><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-4d9bdc00><!--[--><li property="itemListElement" typeof="ListItem" data-v-4d9bdc00><a class="vp-link link breadcrumb" href="/" property="item" typeof="WebPage" data-v-4d9bdc00><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-4d9bdc00></span><meta property="name" content="首页" data-v-4d9bdc00><meta property="position" content="1" data-v-4d9bdc00></li><li property="itemListElement" typeof="ListItem" data-v-4d9bdc00><a class="vp-link link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-4d9bdc00><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-4d9bdc00></span><meta property="name" content="博客" data-v-4d9bdc00><meta property="position" content="2" data-v-4d9bdc00></li><li property="itemListElement" typeof="ListItem" data-v-4d9bdc00><a class="vp-link link breadcrumb" href="/article/categories/?id=dbc378" property="item" typeof="WebPage" data-v-4d9bdc00><!--[-->网络<!--]--><!----></a><span class="vpi-chevron-right" data-v-4d9bdc00></span><meta property="name" content="网络" data-v-4d9bdc00><meta property="position" content="3" data-v-4d9bdc00></li><li property="itemListElement" typeof="ListItem" data-v-4d9bdc00><a class="vp-link link breadcrumb current" href="/article/xmnoxe10/" property="item" typeof="WebPage" data-v-4d9bdc00><!--[-->Lucky搭配Cloudflare穿透内网实践<!--]--><!----></a><!----><meta property="name" content="Lucky搭配Cloudflare穿透内网实践" data-v-4d9bdc00><meta property="position" content="4" data-v-4d9bdc00></li><!--]--></ol></nav><!--[--><!--]--><!--[--><div class="vp-doc-title" data-v-403b82e6><!--[--><!--]--><h1 class="page-title" data-v-403b82e6><!----> Lucky搭配Cloudflare穿透内网实践 <!----></h1><!--[--><!--]--></div><div class="vp-doc-meta" data-v-403b82e6><!--[--><!--]--><p class="reading-time" data-v-403b82e6><span class="vpi-books icon" data-v-403b82e6></span><span data-v-403b82e6>约 7428 字</span><span data-v-403b82e6>大约 25 分钟</span></p><p data-v-403b82e6><span class="vpi-tag icon" data-v-403b82e6></span><!--[--><a class="vp-link link tag vp-tag-heta" href="/article/tags/?tag=lucky" data-v-403b82e6><!--[-->lucky<!--]--><!----></a><a class="vp-link link tag vp-tag-nqac" href="/article/tags/?tag=cloudflare" data-v-403b82e6><!--[-->cloudflare<!--]--><!----></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-403b82e6><span class="vpi-clock icon" data-v-403b82e6></span><span data-v-403b82e6>2025-12-14</span></p></div><!--]--><!--[--><!--]--><div class="_article_xmnoxe10_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-5e118bb0><!--[--><!--]--><div data-v-5e118bb0><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>之前有写过<a class="vp-link link" href="/article/r9qcnh6l/"><!--[-->Lucky内网穿透实践<!--]--><!----></a><span class="vp-annotation ignore-header lucky_pass" data-v-067cf25b><span aria-label="lucky_pass" class="vpi-annotation" data-v-067cf25b></span><!----></span>，其中介绍了利用 Lucky 做内网穿透的使用方式，今天继续介绍搭配 Cloudflare 的使用技巧。</p><p>多说一句，内网穿透的方式很多，有商业付费方案，付了钱开通账号直接用；也有个人付费方案，买个轻量云主机，搭建 frp、wireguard、tailscale derp 节点等。但那些都不在本次讨论范围内，多数使用场景下都不是必要付费的，而本文要说的是，纯免费打造媲美付费效果的内网穿透方案。</p><p>开始本文前，一个假设的前提是已经利用 Lucky 做好了 Stun 内网穿透，如果没有建议先看<a class="vp-link link" href="/article/r9qcnh6l/"><!--[-->Lucky内网穿透实践<!--]--><!----></a>。<br><strong>能够实现效果</strong>：<mark>通过一个域名无端口访问到内网，且支持双栈网络访问</mark>。</p><p><strong>开始前的准备</strong>：</p><ol><li>一个 Cloudflare 账号。如果没有先去官网免费<a href="https://cloudflare.com" target="_blank" rel="noopener noreferrer">注册</a>；</li><li>至少一个域名，并指向了 Cloudflare 的 DNS 服务器。如果没有可以从<a href="https://digitalplat.org" target="_blank" rel="noopener noreferrer">DigitalPlat</a>、<a href="https://www.dnshe.com" target="_blank" rel="noopener noreferrer">DNSHE</a>免费获取，然后托管到 Cloudflare；</li></ol><h2 id="_1-穿透原理" tabindex="-1"><a class="header-anchor" href="#_1-穿透原理"><span>1. 穿透原理</span></a></h2><p>我认为在进行一项新事务前，如果时间允许的话，应该先了解其工作原理。如果直接上手，会导致做的过程中云里雾里，很容易在无意中出错，然后花费大量时间排查，效率极其低下。<br> 而实现了解原理也有助于自身评估，是否需要花费精力操作，因为每个人有不同的使用场景，没有永远的银弹，只有适合自己的才是最好的方案。</p><p>首先，在 FullCone NAT 的网络模式下，Lucky 会利用 STUN 协议打洞，在运营商的路由器上打通一个 NAT 映射，并维持住这个映射，之后任意客户端都可以通过这个映射到内网服务。</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div style="display:flex;align-items:center;justify-content:center;height:96px;" class="mermaid-loading"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!--]--><p>这就是 STUN 打洞的过程：内网服务依次通过家庭路由器和运营商路由器两层NAT，每一次的NAT都会在路由器上留下一个地址和端口的映射，最终以一个公网身份请求同样处于公网的STUN服务器。接着STUN服务器返回响应，回传这个公网地址，那么内网服务就知道了自己的公网身份了，只要维持住这个映射，那么任意设备就可以通过访问这个公网地址达到内网服务了。</p><p>其中<code>100.80.48.188</code>这个是运营商大内网中的地址，如果在同一运营商网络(移动/联通/电信)下，是可以拿这个地址访问的；而<code>189.123.45.67:31580</code>就是真正的公网地址，任意运营商网络下的设备都可以访问到。</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div style="display:flex;align-items:center;justify-content:center;height:96px;" class="mermaid-loading"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!--]--><p>从大的角度看，外部网络访问到内网的过程是这样，而内网中又如何将请求转发到实际提供服务的机器上呢？</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div style="display:flex;align-items:center;justify-content:center;height:96px;" class="mermaid-loading"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!--]--><p>这里要说名明的一下，我的 Lucky 是部署在主路由的 OpenWrt 上，光猫桥接用主路由拨号。如果你不能设置光猫桥接，或者 Lucky 没有部署在主路由上，那就需要用到 DMZ 或者 Upnp 把 Lucky 需要穿透的端口映射到拨号设备上。<br> 举例：通过 Lucky 设置 STUN 穿透时，要指定一个<code>穿透通道本地端口</code>，假如是<code>7788</code>。这个意思是，由于公网的 ip 和 port 是动态的、随机的，指不定什么是否就会变的，但是本地得监听一个固定的端口，那么公网流量通过<code>31580</code>这个随机端口访问进来，流量到了路由器后实际是到了<code>eth0</code>这个网卡的<code>7788</code>端口。</p><p>路由器上通常都可以看到<code>WAN</code>口和<code>LAN</code>口，其中<code>WAN</code>口接的是光猫，连接到的是外部网络，而外部流量进来也是到达了<code>eth0</code>网卡，当拨号上网成功时，这个网卡就会被运营商分配一个 ip(100.80.48.188)；<code>LAN</code>口是内网交互的网口，对应的网卡名通常是<code>eth1</code>，它的 ip 通常是静态的，也就是我们常常设置的 192.168.0.1。</p><p>我们内网中的设备通常都是 192.168.0.x，也就是说它和<code>eth1</code>网卡是通的，但刚刚我们说外部流量是打到了<code>eth0</code>的 7788 端口。那我们就需要把<code>eth0</code>的 7788 端口上到流量转发到<code>eth1</code>上某个 ip 的某个端口上，这个转发操作可以在路由器上的防火墙设置<code>端口转发</code>，也可以直接让 Lucky 内部自行转发，但推荐使用防火墙那的<code>端口转发</code>，因为那是内核级的转发，性能会更高一些，资源占用也会更低一些。</p><p><strong>重要</strong>：<mark>Lucky 服务千万不能经过任何网络代理，即使把模式设置为直连也不行，因为代理软件为了做规则分流，通常会接管所有的 DNS 请求，统一返回 fakeip，这会导致 Lucky 的 STUN 穿透无法获取到正确的公网 ip</mark>。</p><h2 id="_2-ddns分流" tabindex="-1"><a class="header-anchor" href="#_2-ddns分流"><span>2. DDNS分流</span></a></h2><p>Lucky 的功能很强大，除了可以帮我们获取到公网地址，可以做 DDNS 将公网 ip 同步到 DNS 记录中。假设我们上面准备的域名是<code>happy.de5.net</code>，如果把ipv4 和 ipv6 的地址都记录到<code>happy.de5.net</code>和<code>*.happy.de5.net</code>，到时候公网该如何访问？<br> 在当前的网络环境下，我们是通过 STUN 拿到的 ipv4 公网，地址和端口都是动态的，而非原生的公网地址，但 ipv6 的公网地址是原生的。<br> 假设内网中反代服务监听了端口 666 转发到后端的 8080 端口，如果外网设备用 ipv6 地址访问时，就应该用<code>https://happy.de5.net:666</code>，通过固定的端口就可以了；但是如果外网用的是 ipv4 访问时，就应该用<code>https://happy.de5.net:31580</code>，通过随机端口访问，并且这个随机端口还是会变的。可是外网设备一般不会主动选择用 ipv4 还是 ipv6 发起请求，这取决于设备所处的网络环境。而通常家用路由器的 ipv6 开关是关闭的，这种情况下就拿不到 ipv6 地址，别人无法通过 ipv6 访问你，而没有 ipv6 地址的设备更是无法访问你。</p><p>有人可能会说，可以设置 SRV 记录啊，支持同时记录 ip 和 端口号，确实是，Lucky 也支持 SRV 记录，但问题是：不是所有的设备都支持查询 SRV 记录，比如浏览器就不会，它只会找 A/AAAA 记录，也就是去查询你的 ipv4/ipv6 地址，如果查不到记录，那就报错。</p><blockquote><p>似乎没有优解方案了？</p></blockquote><p>别着急，我们换个角度想想，既然合在一起不行，那干脆就把 ipv4 和 ipv6 分开来设置，然后外部请求时统一用一个入口，根据来源 ip 类型将请求实际打到我们的 ipv4 或 ipv6 地址上去。这个意思不就和反向代理差不多了吗？Ok，既然想清楚了，那就开始干。</p><blockquote><p>申请证书及 DDNS</p></blockquote><p>Lucky 确实很强大，你可能需要的网络相关的东西，它都提供给你了，包括证书申请及续期。操作起来非常简单，具体看开头提到的文章，这里只说思路。</p><p>我们分别为<code>*.v4.happy.de5.net</code>和<code>*.v6.happy.de5.net</code>这两个泛域名申请证书，前缀可以随意，这里用<code>v4</code>和<code>v6</code>主要是为了见名知意。然后利用 Lucky 提供的 DDNS 功能，将 ipv4 地址解析到<code>*.v4.happy.de5.net</code>，将 ipv6 地址解析到<code>*.v6.happy.de5.net</code>。<mark>注意</mark>：不要勾选<code>指定代理状态</code>。如果勾选了，在 Cloudflare 上托管域名的 DNS 记录就会被代理，显示一个黄色的云朵，也就是常说的<code>小黄云</code>。</p><blockquote><p>为什么不要开启小黄云？</p></blockquote><p>一旦开启了小黄云，你的 DNS 记录就会被 Cloudflare 代理，表现为：当你 ping <code>v4.happy.de5.net</code> 或 <code>v6.happy.de5.net</code> 的任意子域名时，得到的是 Cloudflare 的泛ip，而非你自己的真实ip。好处是可以隐藏你的真实 ip，并且享受 cloudflare 带来的安全防护，坏处是支持访问的端口有限，stun 拿到的公网端口都是随机的，很可能就是 cloudflare 不支持的，并且也不能被 workers 和 pages 访问。<br> 当开启了小黄云时，你的服务器对于 cloudflare 来说就是源站，公网请求到 cloudflare，cloudflare 到源站的这个过程叫做“回源”。</p><h2 id="_3-重定向规则" tabindex="-1"><a class="header-anchor" href="#_3-重定向规则"><span>3. 重定向规则</span></a></h2><p>如果说上一个步骤是分离，这个步骤就是合并。通过访问一个域名 https://ok.happy.de5.net，根据访问者的 ip 类型，浏览器自动重定向到 https://ok.v4 .happy.de5.net:31580 或 https://ok.v5.happy.de5.net:666。要实现这个效果就得利用 Cloudflare 的<code>重定向规则</code>。</p><p>点击托管在 Cloudflare 上的域名<code>happy.de5.net</code>，接着在左侧菜单找到<code>规则</code>-&gt;<code>概述</code>，点击<code>创建规则</code>。<br> 我们可以为 ipv4 和 ipv6 分别创建规则。</p><h3 id="_3-1-创建-ipv4-重定向规则" tabindex="-1"><a class="header-anchor" href="#_3-1-创建-ipv4-重定向规则"><span>3.1 创建 ipv4 重定向规则</span></a></h3><p><strong>编辑单一重定向</strong></p><p>规则名称：home-redirect-v4</p><p><strong>如果传入请求匹配…</strong></p><p>选择<code>自定义筛选表达式</code></p><p><strong>当传入请求匹配时...</strong></p><table><thead><tr><th style="text-align:center;">字段</th><th style="text-align:center;">运算符</th><th style="text-align:center;">值</th><th style="text-align:center;">条件</th></tr></thead><tbody><tr><td style="text-align:center;">主机名</td><td style="text-align:center;">等于</td><td style="text-align:center;">*.happy.de5.net</td><td style="text-align:center;">And</td></tr><tr><td style="text-align:center;">IP源地址</td><td style="text-align:center;">包含以下各项</td><td style="text-align:center;">0.0.0.0/0</td><td style="text-align:center;"></td></tr></tbody></table><p>表达式预览</p><blockquote><p>(http.host eq &quot;*.happy.de5.net&quot; and ip.src in {0.0.0.0/0})</p></blockquote><p><strong>则...</strong></p><p>URL 重定向</p><table><thead><tr><th style="text-align:center;">类型</th><th style="text-align:center;">表达式</th><th style="text-align:center;">状态码</th></tr></thead><tbody><tr><td style="text-align:center;">动态</td><td style="text-align:center;">wildcard_replace(http.request.full_uri, &quot;https://*.happy.de5.net/*&quot;, &quot;https://${1}.v4.happy.de5.net:31580/${2}&quot;)</td><td style="text-align:center;">307</td></tr></tbody></table><p>勾选<code>保留查询字符串</code></p><hr><p>上述说明：</p><ol><li>ip 来源值为 0.0.0.0/0，就表示匹配所有的 ipv4 地址。</li><li>https://*.happy.de5.net/* 这里的 * 就是占位符，可以指代任意字符串。https://${1}.v4.happy.de5.net:31580/${2} ，这里 ${1} 就表示引用第 1 个 * 的内容， ${2} 表示引用第 2 个 * 的内容，以此类推。</li><li>307/302 表示临时重定向， 305/301 表示永久重定向。如果永久重定向的话，浏览器会记住重定向后的地址，这里我们当然要用临时重定向。而 302 是历史遗留产物，不规范，无论重定向前是哪种请求方式，重定向后都变成了 GET 请求，这就可能会丢失请求 body，而 307 就很好的保留了原始的请求方式。</li></ol><p><strong>重定向规则这里有个问题</strong></p><p>举例，原始请求：https://okk.happy.de5.net/best，重定向后：https://okk.v4.happy.de5.net/best:31580。<br> 31580 是 STUN 拿到的动态公网端口，一旦发生了变化这条重定向规则就走不通了。</p><p>好在 Cloudflare 的设置都提供了 api 方式修改，我们完全可以在 STUN 的 WebHook 处来发起一个请求来修改重定向规则。</p><p>具体步骤如下：</p><ol><li>获取 Api 令牌</li></ol><p>点击右上角<code>个人简介</code>-&gt;<code>配置文件</code>，再点击左侧菜单中的<code>API令牌</code>，在<code>API令牌</code>区域点击<code>创建令牌</code>-&gt;<code>自定义令牌</code>。</p><p>令牌名称：随意</p><p>权限：<br><code>账户</code> <code>账户规则集</code> <code>编辑</code><br><code>区域</code> <code>单一重定向</code> <code>编辑</code></p><p>帐户资源：<br><code>包括</code> <code>{你的账户}</code></p><p>区域资源：<br><code>包括</code> <code>特定区域</code> <code>happy.de5.net</code></p><p>接着保存并记下 Api令牌。</p><ol start="2"><li>获取区域(Zone)ID</li></ol><p>点击托管的域名，将页面拉到最下面，就可以看到<code>区域ID</code>。</p><ol start="3"><li>获取重定向规则集ID</li></ol><p>发起如下请求：</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-plain"><span class="line"><span>GET https://api.cloudflare.com/client/v4/zones/{区域ID}/rulesets</span></span>
<span class="line"><span>Authorization: Bearer {Api令牌}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>在响应结果中搜索<code>http_request_dynamic_redirect</code>，这一项的 id 就是重定向的<code>规则集ID</code>。</p><ol start="4"><li>获取重定向规则</li></ol><p>发起如下请求：</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-plain"><span class="line"><span>GET https://api.cloudflare.com/client/v4/zones/{区域ID}/rulesets/{规则集ID}</span></span>
<span class="line"><span>Authorization: Bearer {Api令牌}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>在响应结果中就可以看到刚刚设置的重定向规则<code>home-redirect-v4</code>，这一项的 id 就是<code>规则ID</code>。</p><ol start="5"><li>修改重定向规则</li></ol><p>发起如下请求：</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-plain"><span class="line"><span>PATCH https://api.cloudflare.com/client/v4/zones/{区域ID}/rulesets/{规则集ID}/{规则ID}</span></span>
<span class="line"><span>Authorization: Bearer {Api令牌}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;description&quot;: &quot;home-redirect-v4&quot;,</span></span>
<span class="line"><span>  &quot;enabled&quot;: true,</span></span>
<span class="line"><span>  &quot;expression&quot;: &quot;(http.host eq \&quot;*.happy.de5.net\&quot; and ip.src in {0.0.0.0/0})&quot;,</span></span>
<span class="line"><span>  &quot;action&quot;: &quot;redirect&quot;,</span></span>
<span class="line"><span>  &quot;action_parameters&quot;: {</span></span>
<span class="line"><span>    &quot;from_value&quot;: {</span></span>
<span class="line"><span>      &quot;preserve_query_string&quot;: true,</span></span>
<span class="line"><span>      &quot;status_code&quot;: 307,</span></span>
<span class="line"><span>      &quot;target_url&quot;: {</span></span>
<span class="line"><span>        // 假设 STUN 获取到的最新公网端口是 25778</span></span>
<span class="line"><span>        &quot;expression&quot;: &quot;wildcard_replace(http.request.full_uri, \&quot;https://*.happy.de5.net/*\&quot;, \&quot;https://${1}.v4.happy.de5.net:25778/${2}\&quot;)&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-创建-ipv6-重定向规则" tabindex="-1"><a class="header-anchor" href="#_3-2-创建-ipv6-重定向规则"><span>3.2 创建 ipv6 重定向规则</span></a></h3><p><strong>编辑单一重定向</strong></p><p>规则名称：home-redirect-v6</p><p><strong>如果传入请求匹配…</strong></p><p>选择<code>自定义筛选表达式</code></p><p><strong>当传入请求匹配时...</strong></p><table><thead><tr><th style="text-align:center;">字段</th><th style="text-align:center;">运算符</th><th style="text-align:center;">值</th><th style="text-align:center;">条件</th></tr></thead><tbody><tr><td style="text-align:center;">主机名</td><td style="text-align:center;">等于</td><td style="text-align:center;">*.happy.de5.net</td><td style="text-align:center;">And</td></tr><tr><td style="text-align:center;">IP源地址</td><td style="text-align:center;">包含以下各项</td><td style="text-align:center;">2000::/3</td><td style="text-align:center;"></td></tr></tbody></table><p>表达式预览</p><blockquote><p>(http.host eq &quot;*.happy.de5.net&quot; and ip.src in {2000::/3})</p></blockquote><p><strong>则...</strong></p><p>URL 重定向</p><table><thead><tr><th style="text-align:center;">类型</th><th style="text-align:center;">表达式</th><th style="text-align:center;">状态码</th></tr></thead><tbody><tr><td style="text-align:center;">动态</td><td style="text-align:center;">wildcard_replace(http.request.full_uri, &quot;https://*.happy.de5.net/*&quot;, &quot;https://${1}.v6.happy.de5.net:666/${2}&quot;)</td><td style="text-align:center;">307</td></tr></tbody></table><p>勾选<code>保留查询字符串</code></p><hr><p>说明：和 ipv4 的重定向规则差不多，<code>2000::/3</code>包含了所有的 ipv6，表示匹配所有的 ipv6 地址。但重定向的端口可以是固定的 666，因为 ipv6 是原生的公网 ip，所以就不需要像 ipv4 那样通过 api 来修改规则了。当然，如果想修改也行，跟修改 ipv4 重定向规则一样的方式。</p><p>发起如下请求：</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-plain"><span class="line"><span>PATCH https://api.cloudflare.com/client/v4/zones/{区域ID}/rulesets/{规则集ID}/{规则ID}</span></span>
<span class="line"><span>Authorization: Bearer {Api令牌}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;description&quot;: &quot;home-redirect-v6&quot;,</span></span>
<span class="line"><span>  &quot;enabled&quot;: true,</span></span>
<span class="line"><span>  &quot;expression&quot;: &quot;(http.host eq \&quot;*.happy.de5.net\&quot; and ip.src in {2000::/3})&quot;,</span></span>
<span class="line"><span>  &quot;action&quot;: &quot;redirect&quot;,</span></span>
<span class="line"><span>  &quot;action_parameters&quot;: {</span></span>
<span class="line"><span>    &quot;from_value&quot;: {</span></span>
<span class="line"><span>      &quot;preserve_query_string&quot;: true,</span></span>
<span class="line"><span>      &quot;status_code&quot;: 307,</span></span>
<span class="line"><span>      &quot;target_url&quot;: {</span></span>
<span class="line"><span>        &quot;expression&quot;: &quot;wildcard_replace(http.request.full_uri, \&quot;https://*.happy.de5.net/*\&quot;, \&quot;https://${1}.v6.happy.de5.net:666/${2}\&quot;)&quot;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-设置-dns-记录" tabindex="-1"><a class="header-anchor" href="#_3-3-设置-dns-记录"><span>3.3 设置 DNS 记录</span></a></h3><p>最后还有一个重要的步骤，手动为<code>happy.de5.net</code>设置两个 DNS 记录。</p><table><thead><tr><th style="text-align:center;">类型</th><th style="text-align:center;">名称</th><th style="text-align:center;">内容</th><th style="text-align:center;">代理状态</th><th style="text-align:center;">TTL</th></tr></thead><tbody><tr><td style="text-align:center;">A</td><td style="text-align:center;">@</td><td style="text-align:center;">192.0.2.1</td><td style="text-align:center;">启用</td><td style="text-align:center;">自动</td></tr><tr><td style="text-align:center;">A</td><td style="text-align:center;">*</td><td style="text-align:center;">192.0.2.1</td><td style="text-align:center;">启用</td><td style="text-align:center;">自动</td></tr></tbody></table><p>这两个记录一定要打开小黄云，才能触发重定向规则。其中<code>192.0.2.1</code>是一个非常特殊的 IP 地址，在 RFC 5737 规范中，它是仅用于演示、举例、写书的一个地址，不是一个有效的主机地址。你也可以设置为 0.0.0.0，随便都可以。这也就是为什么证书只申请<code>*.v4.happy.de5.net</code>和<code>*.v5.happy.de5.net</code>，而<code>happy.de5.net</code>和<code>*.happy.de5.net</code>不需要证书，因为它们指向的不是有效的主机，TCP 三次握手都完成不了，更别提后面的 Client Hello 拿证书了。根域名的作用仅仅是用来做重定向。</p><hr><p>经过上面的操作，我们就可以做到通过浏览器访问一个地址，自动重定向到不同的子域，支持双栈网络访问。</p><p>但是有但是，这种方式只适合用于浏览器环境，对于一些 api 服务来说，你返回给它 302/307 根本不行，它只认 200，不是就报错。并且这还可能有资源跨域问题。浏览器地址栏有端口号丑不说，还会暴露真实的 ip 地址。</p><p>那我们就换一种方式，结合 worker 来做。</p><h2 id="_4-worker-反代" tabindex="-1"><a class="header-anchor" href="#_4-worker-反代"><span>4. Worker 反代</span></a></h2><h3 id="_4-1-workers-说明" tabindex="-1"><a class="header-anchor" href="#_4-1-workers-说明"><span>4.1 Workers 说明</span></a></h3><p>Cloudflare 这个赛博善人提供了 Workers&amp;Pages。Workers 可以在边缘节点上执行 Serverless 函数，Pages 则可以托管静态网站，同时也能执行 Serverless 函数。</p><p>Pages 的功能很好理解，它就类似于 GitHub Pages、Vercel、Netlify 可以托管静态网站，不过 GitHub Pages 不能执行函数，Vercel 和 Netlify 可以。当前这个博客就是托管在 Vercel 和 Netlify 上。</p><p>Workers 的功能似乎有点看不懂，什么是边缘节点？什么是 Serverless？能执行什么函数？</p><blockquote><p>什么是边缘节点？</p></blockquote><p>首先“节点”指的就是 Cloudflare 的服务实例。Cloudflare 在全球各地都有机房，因此节点也就遍布全球。</p><p>“边缘”指的就是网络位置距离你最近的地方，因此“边缘节点”指的就是在网络位置上离你最近的那个 Cloudflare 服务实例。</p><p>因为你在 Workers 上部署的函数，Cloudflare 会自动同步到全球各个节点上去，如果你没做“Worker路由规则”或其他防护，任何人都可以访问到你的函数。<br> 假设 Cloudflare 在香港、东京、洛杉矶、首尔有节点，这些节点上都会存在你的函数，香港朋友如果要访问你的函数，就近原则就会请求到香港节点；美国朋友如果要访问你的函数，就近原则就会请求到洛杉矶节点。这么做的好处很明显，全球任何位置的人都就近访问边缘节点，能有效降低延迟。</p><p>其实类似的我们还听过“边缘网关”，尤其是智能家居物联网场景下，各种设备通过WIFI、蓝牙或者Zigbee互联，总得需要一个中枢(相当于指挥中心)，这个中枢就是网关，因为网关处于内网中，在网络上离我们最近，因此也叫做“边缘网关”。 我们还听说过“边缘计算”呢，比如你的小爱音箱或者天猫精灵，它就是一个“边缘网关”，当我们给它发送指令，有些是简单指令，比如“定个闹钟”、“xx分钟后提醒我”、“打开主灯”，这些指令都是小爱音箱自身就能计算并完成的，就是“边缘计算”；而对于一些复杂指令，比如“最近的国际局势”、“分析过去两周的黄金走势”，这些就会发送到小米服务器(云端)计算，也就是“云计算”。<br> “边缘计算”的优势在于快，免去网络延迟开销就能完成任务；“云计算”的优势在于强大，能完成更复杂且多样性的任务。当然在 AI 发展的今天，边缘网关的硬件也可以内置一些小模型，支持在本地做一些复杂计算和分析任务了。</p><blockquote><p>什么是 Serverless？</p></blockquote><p>传统意义上，我们编码写了几个函数，无论是什么语言，如果要提供访问，就得启动一个服务器，监听 TCP/UDP，一个或多个端口。也就是说，要想提供服务就得有 Server，我们还得维持这个 Server 运行，一旦 Server 停止，函数也就无法执行了。<br> 而 Serverless 就是让我们不用创建 Server，更不用关心 Server 的存在，函数部署到 Worker 上就能提供访问。既然连 Server 的不用创建，也就无需维持 Server 了。</p><p>传统服务器计费按照 CPU(规格、频率、核数)、内存、硬盘、带宽、流量等多种维度计费。你一旦买了服务器，这些费用就产生了，即使你没用放在那吃灰，那也是要给钱的，因此成本就相对较高。<br> 而 Serverless 的 CPU(规格、频率、核数)、内存、硬盘、带宽、流量等都是共享的，当你的函数需要运行，Cloudflare 会调度 CPU 给你执行，按照执行时间收费，不执行就不收费，其他资源也是同样的，用多少花多少。要是不用放那吃灰，那就不收你钱，可以说优势很明显。</p><blockquote><p>能执行什么函数？</p></blockquote><p>可以用 Node.js 写函数，比如：正向代理、反向代理、管理系统等等，结合Cloudflare 提供的免费 KV、D1、R2 等多种存储方式，可以实现更多功能。</p><h3 id="_4-2-资源限制" tabindex="-1"><a class="header-anchor" href="#_4-2-资源限制"><span>4.2 资源限制</span></a></h3><p>Cloudflare 真的是相当慷慨，即使是免费账户，提供的资源也是非常的充裕，个人使用很难触及上限。</p><p>比如，Workers&amp;Pages 每日请求最大限额 10W 次。这里指的是单个账户下所有 Workers&amp;Pages 的请求次数总和。</p><p>每个 Worker 中函数执行的最大 CPU 时间是 10ms，这意味着只要不是做复杂的加/解密，死循环，批量读写大文件，几乎是达不到这个限制的。而 KV 存储更是每日 1000次写操作，10W 次读操作。</p><h3 id="_4-3-部署函数" tabindex="-1"><a class="header-anchor" href="#_4-3-部署函数"><span>4.3 部署函数</span></a></h3><p>为了规避前面重定向的一些问题，我们可以借助 Worker 来做一个反向代理服务，代码如下：</p><div class="code-block-title" data-title="_worker.js"><div class="code-block-title-bar"><span class="title"><!---->_worker.js</span></div><div class="language-js line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="js" style="--vp-collapsed-lines:15;--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-js"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 定义KV键名</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> KV_KEY_PORT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">stun_port</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">export</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> default</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  async</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> fetch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 处理POST API请求，用于更新端口</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> URL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">method</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ===</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">POST</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;&amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pathname</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ===</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/api/stun</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 验证Token</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> authHeader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Authorization</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> expectedToken</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">TOKEN</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">authHeader</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">expectedToken</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">          return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">JSON</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stringify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Unauthorized: Missing token.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }),</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 401</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">application/json</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> parts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> authHeader</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">split</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">parts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">length</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> parts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Bearer</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> parts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> expectedToken</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">          return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">JSON</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stringify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Unauthorized: Invalid token.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }),</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 401</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">application/json</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 解析JSON请求体</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> body</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> await</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">json</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> body</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 验证port值</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">port</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> typeof</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> port</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">number</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &lt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ||</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 65535</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">          return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">JSON</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stringify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Invalid port number.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }),</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 400</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">            headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">application/json</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 2. 保存到KV (必须转为字符串)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        await</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">KV_STORE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">put</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">KV_KEY_PORT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">JSON</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stringify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> code</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> success</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }),</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 200</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">application/json</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">err</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">JSON</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stringify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Processing error: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> err</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">message</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }),</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 400</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">application/json</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 获取客户端IP</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ipHeaders</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cf-connecting-ip</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">x-forwarded-for</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">x-real-ip</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">true-client-ip</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> clientIP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    for</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> header</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> of</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ipHeaders</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">header</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        clientIP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> header</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ===</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">x-forwarded-for</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ?</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">split</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">].</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">trim</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> :</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        break</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">!</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">clientIP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">JSON</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">stringify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Bad Request: Unknown client ip.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }),</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 400</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">application/json</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 1. 根据IP版本确定主后端</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    let</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> primaryBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">clientIP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">includes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">      primaryBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BACKEND_V6</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">      // IPv4地址 - 动态获取端口</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">      const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> v4Port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> await</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">KV_STORE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">KV_KEY_PORT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">v4Port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        primaryBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BACKEND_V4</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">v4Port</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> else</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">        primaryBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 2. 尝试请求主后端</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">primaryBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> reqClone</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">clone</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        return</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> await</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sendToBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">reqClone</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> primaryBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">err</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 主后端失败，继续到兜底逻辑</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 3. 兜底</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      return</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> await</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sendToBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> `</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">env</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BACKEND_FB</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> catch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fallbackErr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">      return</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Service Unavailable</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> status</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 503</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> });</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  },</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">async</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> function</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> sendToBackend</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">originalRequest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> backendUrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> URL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">originalRequest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> targetUrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> URL</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pathname</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> +</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">search</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> backendUrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> newReq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">targetUrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    method</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> originalRequest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">method</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> originalRequest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    body</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> originalRequest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    redirect</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">follow</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    signal</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> AbortSignal</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">timeout</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">5000</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 使用超时信号</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">  newReq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">headers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Host</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> targetUrl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">hostname</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 发送请求并验证结果</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  const</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> await</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> fetch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newReq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  // 状态码不是200则认为失败，抛出错误让调用方处理</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">status</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> !==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 200</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    throw</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> new</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Error</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Backend returned non-200 status: </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">status</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">  return</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> response</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div></div><p>打开 Cloudflare 主页下左侧菜单<code>计算和AI</code>-&gt;<code>Workers 和 Pages</code>，右上角<code>创建应用程序</code>，名称随意。<br> 部署完后，在Worker的<code>设置</code>-&gt;<code>变量和机密</code>添加一个<code>TOKEN</code>。然后在左侧<code>存储和数据库</code>-&gt;<code>Workers KV</code>创建一个实例，名称随意。然后在创建的 Worker 中<code>绑定</code>选择刚刚创建的 KV 实例，绑定名称为<code>KV_STORE</code>。</p><p>建议可以放弃 url 重定向那套玩法，除非特别需要。这样我们就可以移除掉<code>happy.de5.net</code>和<code>*.happy.de5.net</code>这两个 DNS 记录，然后可以给 Worker 绑定一个域名，如<code>happy.de5.net</code>，可以把<code>okk.happy.de5.net</code>绑定给 Tunnel。前端只需要访问<code>happy.de5.net</code>，Worker 会自动帮我们代理进行后端访问，同样支持双栈网络。</p><p>当然，完全可以注册多个域名，因为<code>DigitalPlat</code>免费就可以注册两个域名，<code>DNSHE</code>最多可以免费注册5个域名。</p><p>访问策略如下：</p><ol><li>如果是 ipv4 地址连接就转发到<code>*.v4.happy.de5.net</code>，否则转发到<code>*.v6.happy.de5.net</code>。</li><li>如果上述请求不成功，则转发到 Tunnel 进行兜底。</li></ol><p>因此，实际上我们是结合使用了内网穿透的 3 种方式：STUN、V6、Tunnel。</p><h2 id="_5-tunnel" tabindex="-1"><a class="header-anchor" href="#_5-tunnel"><span>5. Tunnel</span></a></h2><p>前面提到了 Cloudflare Tunnel，它也是一种内网穿透方式，通过内网运行 Tunnel 实例，一个实例下有 4 个连接器，分别会连接到不同的 Cloudflare 节点，做服务端的高可用方案。Tunnel 自身还提供了客户端高可用的方案，只要用相同的配置起多个 Tunnel 实例，它们会自动管理连接，单节点故障转移。</p><p>下载<a href="https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/downloads/" target="_blank" rel="noopener noreferrer">Tunnel</a>并在内网中任意一台设备上运行，或者直接下载Docker<a href="https://hub.docker.com/r/cloudflare/cloudflared" target="_blank" rel="noopener noreferrer">镜像</a>用容器跑也行。当然，也有 OpenWrt 的版本。</p><p>Cloudflare 上要在主页左侧菜单点击<code>Zero Trust</code>-&gt;<code>网络</code>-&gt;<code>连接器</code>，创建隧道。<br> 然后拿着<code>隧道ID</code>和<code>令牌</code>，填写配置文件：</p><div class="code-block-title" data-title="config.yaml"><div class="code-block-title-bar"><span class="title"><!---->config.yaml</span></div><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 配置文件参数：</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/configure-tunnels/cloudflared-parameters/run-parameters/</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># - https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/configure-tunnels/cloudflared-parameters/origin-parameters/</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">tunnel</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Sub-Store</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">credentials-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/.cloudflared/{隧道ID}.json</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># edge-ip-version: &quot;4&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># protocol: http2 # quic</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">metrics</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 0.0.0.0:20241</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">loglevel</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> info</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 暴露私网到 CF 的网络中(和 tailscale 的 subnet 一个意思，客户端需要使用 WARP 并启用 zero trust，同样要开 VPN)</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">warp-routing</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  enabled</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">ingress</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> hostname</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> okk.happy.de5.net</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://192.168.0.8:3001</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http_status:404</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>另外还需要一个证书，<a href="https://dash.cloudflare.com/argotunnel" target="_blank" rel="noopener noreferrer">访问</a>，选择<code>happy.de5.net</code>这个域名，点击下载证书<code>cert.pem</code>。</p><div class="code-block-title" data-title="compose.yaml"><div class="code-block-title-bar"><span class="title"><!---->compose.yaml</span></div><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  cloudflared</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloudflare/cloudflared:latest</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    container_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cloudflared</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TUNNEL_TOKEN={令牌}</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TUNNEL_ORIGIN_CERT=/etc/cloudflared/cert.pem</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> NO_AUTOUPDATE=true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    network_mode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> host</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    restart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> unless-stopped</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    command</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tunnel --config /etc/cloudflared/config.yml run</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./cloudflared:/etc/cloudflared</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>然后在公网访问<code>happy.de5.net</code>请求就会到达内网的<code>http://192.168.0.8:3001</code>。</p><p>Cloudflare 的 Tunnel 使用和 Tailscale 的 Funnel 类似。区别在于 Funnel 强制走 derp 中转会很慢，Tunnel 网速就很好。<br> Cloudflare warp 和 Tailscale 的 subnet 又很像，都是可以暴露子网，又都需要使用各自的客户端起启用 VNP 访问。区别在于 Cloudflare 使用的 WARP 在国内已经连不上了，而 Tailscale 客户端还能正常用，它的 subnet 很好用。</p><h2 id="_6-总结" tabindex="-1"><a class="header-anchor" href="#_6-总结"><span>6. 总结</span></a></h2><p>至此，不提 Tailscale 我们一共有 5 种内网穿透的使用方式：单ipv4(STUN)、单ipv6(原生)、Tunnel(兜底)、URL重定向、加密隧道(VPN)，其中最后这种方式在本文的开头提到的文章中有详说，这里不再赘述。</p><p>基于使用场景划分：</p><ol><li>网页端浏览，用重定向方案。</li><li>大流量传输，用 VPN 方案。</li><li>api 调用，用 Worker 反代方案。</li></ol><p>后两种方案结合起来使用体验最丝滑，免费方案也有不输付费的体验🎉。</p><h2 id="补充-2025-12-16" tabindex="-1"><a class="header-anchor" href="#补充-2025-12-16"><span>补充(2025/12/16)</span></a></h2><p>实际使用发现个问题，Worker 中请求<code>sub.v4.happy.de5.net</code>和<code>sub.v6.happy.de5.net</code>总是不能通，最后都会降级到<code>sub.happy.de5.net</code>。后来发现，从海外 ip 访问国内 ip 是会被 GFW 拦截的，ping 域名的时候只有第一次回复，之后就黑洞了，不会再回复了。而 Cloudflare 的节点都是在大陆地区以外的，被拦截就是正常情况了。除非是从国内 ip 访问，但那样花钱是一回事，还要备案实名比较麻烦。<br> 因此，只能改变策略了，把关键的服务部署在公网上，有挺多 PaaS 厂商的服务可以选择，比如：<a href="https://zeabur.com/" target="_blank" rel="noopener noreferrer">Zeabur</a>、<a href="https://leaflow.net/" target="_blank" rel="noopener noreferrer">Leaflow</a>、<a href="https://www.koyeb.com/" target="_blank" rel="noopener noreferrer">Koyeb</a>等，它们都有相当多的免费额度可以使用，这里就以 Zeabur 为例演示。</p><p>对我来讲，关键的服务就是<code>Sub-Store</code>，因此需要在 Zeabur 上部署它，但可惜的是挺多厂商封杀了<a href="https://hub.docker.com/r/xream/sub-store" target="_blank" rel="noopener noreferrer">sub-store</a>镜像。但也有应对策略，那就是自己编译镜像换个名。</p><p>不得不提一嘴，官方的<a href="https://hub.docker.com/r/xream/sub-store" target="_blank" rel="noopener noreferrer">文档</a>写的比较乱，看起来有些费解。并且官方的<a href="https://xream.notion.site/Sub-Store-Hugging-Face-1787ae7c38df482eaeccea4e0f1d3a8d" target="_blank" rel="noopener noreferrer">构建文件</a>写的也不好看。因此在阅读文档➕实践验证过后，优化出来如下版本：</p><div class="vp-code-tree"><div class="code-tree-panel" style="max-height:600px;"><div class="code-tree-title" title="Sub-Store Project"><span>Sub-Store Project</span></div><div class="vp-file-tree"><!--[--><div class="vp-file-tree-node"><p class="file active vp-file-tree-info" style="--file-tree-level:-1;"><!--[--><!----><!--]--><span class="file name">Dockerfile</span><!----></p><!----></div><div class="vp-file-tree-node"><p class="file vp-file-tree-info" style="--file-tree-level:-1;"><!--[--><!----><!--]--><span class="file name">build.sh</span><!----></p><!----></div><!--]--></div></div><div class="code-panel" style="height:600px;"><!--[--><div class="code-block-title" data-title="Dockerfile"><div class="code-block-title-bar"><span class="title"><!---->Dockerfile</span></div><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">FROM node:24-alpine3.21</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR /opt/app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN apk add --no-cache curl unzip tzdata ca-certificates &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    mkdir -p /opt/app/data</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ENV SUB_STORE_FRONTEND_HOST=:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_FRONTEND_PORT=3000 \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_BACKEND_API_HOST=:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_BACKEND_API_PORT=3001 \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_BACKEND_MERGE=true \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_BODY_JSON_LIMIT=10mb \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_FRONTEND_BACKEND_PATH=/subark \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_BACKEND_PREFIX=true \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_FRONTEND_PATH=/opt/app/frontend \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_DATA_BASE_PATH=/opt/app/data \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_MMDB_COUNTRY_PATH=/opt/app/data/GeoLite2-Country.mmdb \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    SUB_STORE_MMDB_ASN_PATH=/opt/app/data/GeoLite2-ASN.mmdb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ARG CACHEBUST=&quot;1970-01-01 00:00:00&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ENV BUILD_TIME=${CACHEBUST}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN echo &quot;Building at ${BUILD_TIME}...&quot; &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    curl -L &quot;https://github.com/sub-store-org/Sub-Store/releases/latest/download/sub-store.bundle.js&quot; -o /opt/app/sub-store.bundle.js &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    curl -L &quot;https://github.com/sub-store-org/Sub-Store-Front-End/releases/latest/download/dist.zip&quot; -o dist.zip &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    unzip dist.zip &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    mv dist frontend &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    rm dist.zip &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    chmod 777 -R /opt/app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN echo &#39;#!/bin/sh&#39; &gt; entrypoint.sh &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    echo &#39;echo &quot;Build time</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> $BUILD_TIME&quot;&#39; &gt;&gt; entrypoint.sh &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    echo &#39;exec node /opt/app/sub-store.bundle.js&#39; &gt;&gt; entrypoint.sh &amp;&amp; \</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    chmod +x entrypoint.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CMD [&quot;./entrypoint.sh&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="code-block-title" data-title="build.sh"><div class="code-block-title-bar"><span class="title"><!---->build.sh</span></div><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> buildx</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --use</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 执行会创建并启动一个容器，所以执行一次就可以了</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 指定一个时区，否则默认是 UTC 时间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> buildx</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> build</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --platform</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> linux/arm64,linux/amd64</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Dockerfile</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --build-arg</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> CACHEBUST=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$(</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">TZ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Asia/Shanghai </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">date</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">+%Y-%m-%d %H:%M:%S</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {你的</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Hub</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 用户名:someone}/{你的项目名称:sube}:v4</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --push</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--]--><div class="code-tree-empty"><span class="vpi-code-tree-empty"></span></div></div></div><p>只需要一键<code>./build.sh</code>即可构建并推送到 DockerHub。绝大多数环境变量已经预定义了，无需过多设置。<br> 此版移除了<code>http-meta</code>功能，内存占用暴降，极大降低了 Zeabur 上的花费。另外推荐使用 Gists 备份，这样也不用挂载目录了。</p><p>Docker Compose 部署如下：</p><div class="code-block-title" data-title="compose.yaml"><div class="code-block-title-bar"><span class="title"><!---->compose.yaml</span></div><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  sube</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sube</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> someone/sube:latest</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3001:3001</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./data:/opt/app/data</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 重要：一定要设置复杂的路径防止被扫导致泄露资源信息，/sube 只是演示值</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> SUB_STORE_FRONTEND_BACKEND_PATH=/sube</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Zeabur 上需要暴露端口<code>3001</code>类型为<code>HTTP</code>，假设给定的域名是<code>sube.zeabur.app</code>，则浏览器地址栏输入<code>https://sube.zeabur.app?api=https://sube.zeabur.app/sube&quot;</code>可一键访问前后端。</p><p><mark>再次强调</mark>：构建自己的镜像使用，名称越无关越好。不要图方便用别人的，否则一旦别人被封，自己也会连坐。</p><hr><div class="hint-container note"><p class="hint-container-title">本文参考</p><ul><li><a href="https://ie12blog.36102025.xyz/articles/lucky-STUN/stun-web-serve-CF" target="_blank" rel="noopener noreferrer">使用Cloudflare的页面规则固定和隐藏网页端口</a></li><li><a href="https://ie12blog.36102025.xyz/articles/lucky-STUN/stun-v4-v6-redirect" target="_blank" rel="noopener noreferrer">IPv4和IPv6分离重定向</a></li><li><a href="https://ie12blog.36102025.xyz/articles/lucky-STUN/stun-cf-redirection" target="_blank" rel="noopener noreferrer">使用Cloudflare的重定向规则传递资源路径和查询字符串</a></li><li><a href="https://ie12blog.36102025.xyz/articles/lucky-STUN/lucky-ddns-2.15" target="_blank" rel="noopener noreferrer">Lucky v2.15 版本后的DDNS配置方法</a></li><li><a href="https://ie12blog.36102025.xyz/the-index/#lucky-%E7%B3%BB%E5%88%97" target="_blank" rel="noopener noreferrer">LUCKY 系列</a></li></ul></div></div><!----><!----><div class="vp-doc-copyright" data-v-5e118bb0><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-53b95284><a href="#doc-copyright" class="header-anchor" data-v-53b95284><span data-v-53b95284><!--[-->版权所有<!--]--></span></a></h2><div class="hint-container tip copyright-container" data-v-79711e76><p data-v-79711e76><span data-v-79711e76>版权归属：</span><a class="vp-link link no-icon" href="https://github.com/Mayee" target="_blank" rel="noreferrer" data-v-79711e76><!--[-->Mayee<!--]--><!----></a></p><!----><p data-v-79711e76><span data-v-79711e76>许可证：</span><a class="vp-link link no-icon" href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer" data-v-79711e76><!--[-->署名 4.0 国际 (CC-BY-4.0)<!--]--><!----></a><!--[--><span class="vpi-license-cc" data-v-79711e76></span><span class="vpi-license-by" data-v-79711e76></span><!--]--></p></div></div></div></main><footer class="vp-doc-footer" data-v-5e118bb0 data-v-3078abbd><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-3078abbd><span class="contributors-label" data-v-3078abbd>贡献者: </span><span class="contributors-info" data-v-3078abbd><!--[--><!--[--><span class="contributor" data-v-3078abbd>Mayee</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-3078abbd><div class="pager" data-v-3078abbd><a class="vp-link link pager-link prev" href="/article/xub0j8lj/" data-v-3078abbd><!--[--><span class="desc" data-v-3078abbd>上一页</span><span class="title" data-v-3078abbd><!----><span data-v-3078abbd>私有仓库跟踪开源项目</span></span><!--]--><!----></a></div><div class="pager" data-v-3078abbd><a class="vp-link link pager-link next" href="/article/6emcwc0t/" data-v-3078abbd><!--[--><span class="desc" data-v-3078abbd>下一页</span><span class="title" data-v-3078abbd><!----><span data-v-3078abbd>构建镜像推送私有仓库</span></span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-dd2ea341 style="display:none;" data-v-d4e26b45><span class="percent" data-allow-mismatch data-v-d4e26b45>0%</span><span class="show icon vpi-back-to-top" data-v-d4e26b45></span><svg aria-hidden="true" data-v-d4e26b45><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-d4e26b45></circle></svg></button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="sign down" class="vp-sign-down" aria-hidden="true" data-v-dd2ea341 style="display:none;" data-v-2a7cf2ea><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" data-v-2a7cf2ea><path d="m19 11l-7 6l-7-6" data-v-2a7cf2ea></path><path d="m19 5l-7 6l-7-6" opacity="0.6" data-v-2a7cf2ea></path></g></svg><footer class="vp-footer" vp-footer data-v-dd2ea341 data-v-b55ba299><!--[--><div class="container" data-v-b55ba299><!----><p class="copyright" data-v-b55ba299>©2021 Mayee</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-B_sKV6fk.js" defer></script></body></html>