---
title: Luckyæ­é…Cloudflareç©¿é€å†…ç½‘å®è·µ
tags:
  - lucky
  - cloudflare
createTime: 2025/12/14 18:38:29
permalink: /article/xmnoxe10/
---

## å‰è¨€

ä¹‹å‰æœ‰å†™è¿‡[Luckyå†…ç½‘ç©¿é€å®è·µ](/article/r9qcnh6l/)[+lucky_pass]ï¼Œå…¶ä¸­ä»‹ç»äº†åˆ©ç”¨ Lucky åšå†…ç½‘ç©¿é€çš„ä½¿ç”¨æ–¹å¼ï¼Œä»Šå¤©ç»§ç»­ä»‹ç»æ­é… Cloudflare çš„ä½¿ç”¨æŠ€å·§ã€‚
[+lucky_pass]: **è®¿é—®å¯†ç **: `pub558787`(åŒå‡»å¤åˆ¶)

å¤šè¯´ä¸€å¥ï¼Œå†…ç½‘ç©¿é€çš„æ–¹å¼å¾ˆå¤šï¼Œæœ‰å•†ä¸šä»˜è´¹æ–¹æ¡ˆï¼Œä»˜äº†é’±å¼€é€šè´¦å·ç›´æ¥ç”¨ï¼›ä¹Ÿæœ‰ä¸ªäººä»˜è´¹æ–¹æ¡ˆï¼Œä¹°ä¸ªè½»é‡äº‘ä¸»æœºï¼Œæ­å»º frpã€wireguardã€tailscale derp èŠ‚ç‚¹ç­‰ã€‚ä½†é‚£äº›éƒ½ä¸åœ¨æœ¬æ¬¡è®¨è®ºèŒƒå›´å†…ï¼Œå¤šæ•°ä½¿ç”¨åœºæ™¯ä¸‹éƒ½ä¸æ˜¯å¿…è¦ä»˜è´¹çš„ï¼Œè€Œæœ¬æ–‡è¦è¯´çš„æ˜¯ï¼Œçº¯å…è´¹æ‰“é€ åª²ç¾ä»˜è´¹æ•ˆæœçš„å†…ç½‘ç©¿é€æ–¹æ¡ˆã€‚

å¼€å§‹æœ¬æ–‡å‰ï¼Œä¸€ä¸ªå‡è®¾çš„å‰ææ˜¯å·²ç»åˆ©ç”¨ Lucky åšå¥½äº† Stun å†…ç½‘ç©¿é€ï¼Œå¦‚æœæ²¡æœ‰å»ºè®®å…ˆçœ‹[Luckyå†…ç½‘ç©¿é€å®è·µ](/article/r9qcnh6l/)ã€‚  
**èƒ½å¤Ÿå®ç°æ•ˆæœ**ï¼š==é€šè¿‡ä¸€ä¸ªåŸŸåæ— ç«¯å£è®¿é—®åˆ°å†…ç½‘ï¼Œä¸”æ”¯æŒåŒæ ˆç½‘ç»œè®¿é—®==ã€‚

**å¼€å§‹å‰çš„å‡†å¤‡**ï¼š
1. ä¸€ä¸ª Cloudflare è´¦å·ã€‚å¦‚æœæ²¡æœ‰å…ˆå»å®˜ç½‘å…è´¹[æ³¨å†Œ](https://cloudflare.com)ï¼›
2. è‡³å°‘ä¸€ä¸ªåŸŸåï¼Œå¹¶æŒ‡å‘äº† Cloudflare çš„ DNS æœåŠ¡å™¨ã€‚å¦‚æœæ²¡æœ‰å¯ä»¥ä»[DigitalPlat](https://digitalplat.org)ã€[DNSHE](https://www.dnshe.com)å…è´¹è·å–ï¼Œç„¶åæ‰˜ç®¡åˆ° Cloudflareï¼›

## 1. ç©¿é€åŸç†

æˆ‘è®¤ä¸ºåœ¨è¿›è¡Œä¸€é¡¹æ–°äº‹åŠ¡å‰ï¼Œå¦‚æœæ—¶é—´å…è®¸çš„è¯ï¼Œåº”è¯¥å…ˆäº†è§£å…¶å·¥ä½œåŸç†ã€‚å¦‚æœç›´æ¥ä¸Šæ‰‹ï¼Œä¼šå¯¼è‡´åšçš„è¿‡ç¨‹ä¸­äº‘é‡Œé›¾é‡Œï¼Œå¾ˆå®¹æ˜“åœ¨æ— æ„ä¸­å‡ºé”™ï¼Œç„¶åèŠ±è´¹å¤§é‡æ—¶é—´æ’æŸ¥ï¼Œæ•ˆç‡æå…¶ä½ä¸‹ã€‚  
è€Œå®ç°äº†è§£åŸç†ä¹Ÿæœ‰åŠ©äºè‡ªèº«è¯„ä¼°ï¼Œæ˜¯å¦éœ€è¦èŠ±è´¹ç²¾åŠ›æ“ä½œï¼Œå› ä¸ºæ¯ä¸ªäººæœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œæ²¡æœ‰æ°¸è¿œçš„é“¶å¼¹ï¼Œåªæœ‰é€‚åˆè‡ªå·±çš„æ‰æ˜¯æœ€å¥½çš„æ–¹æ¡ˆã€‚

é¦–å…ˆï¼Œåœ¨ FullCone NAT çš„ç½‘ç»œæ¨¡å¼ä¸‹ï¼ŒLucky ä¼šåˆ©ç”¨ STUN åè®®æ‰“æ´ï¼Œåœ¨è¿è¥å•†çš„è·¯ç”±å™¨ä¸Šæ‰“é€šä¸€ä¸ª NAT æ˜ å°„ï¼Œå¹¶ç»´æŒä½è¿™ä¸ªæ˜ å°„ï¼Œä¹‹åä»»æ„å®¢æˆ·ç«¯éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ˜ å°„åˆ°å†…ç½‘æœåŠ¡ã€‚

```mermaid
flowchart TB

subgraph å®¶åº­å±€åŸŸç½‘
  a1[LuckyæœåŠ¡å™¨] --> |192.168.0.8å‘èµ·è¯·æ±‚æŸ¥è¯¢å…¬ç½‘åœ°å€|a2[è·¯ç”±å™¨]
end

subgraph è¿è¥å•†å±€åŸŸç½‘
  b1[è·¯ç”±å™¨]
end
a2 --> |NATå100.80.48.188|b1
subgraph äº’è”ç½‘
  c1[STUNæœåŠ¡å™¨]
end

b1 --> |NATå189.123.45.67:31580|c1
c1 --> |æœåŠ¡å™¨è¿”å›çœ‹åˆ°çš„åœ°å€189.123.45.67:31580|b1
b1 --> |å“åº”189.123.45.67:31580|a2
a2 --> |å“åº”189.123.45.67:31580|a1

```

è¿™å°±æ˜¯ STUN æ‰“æ´çš„è¿‡ç¨‹ï¼šå†…ç½‘æœåŠ¡ä¾æ¬¡é€šè¿‡å®¶åº­è·¯ç”±å™¨å’Œè¿è¥å•†è·¯ç”±å™¨ä¸¤å±‚NATï¼Œæ¯ä¸€æ¬¡çš„NATéƒ½ä¼šåœ¨è·¯ç”±å™¨ä¸Šç•™ä¸‹ä¸€ä¸ªåœ°å€å’Œç«¯å£çš„æ˜ å°„ï¼Œæœ€ç»ˆä»¥ä¸€ä¸ªå…¬ç½‘èº«ä»½è¯·æ±‚åŒæ ·å¤„äºå…¬ç½‘çš„STUNæœåŠ¡å™¨ã€‚æ¥ç€STUNæœåŠ¡å™¨è¿”å›å“åº”ï¼Œå›ä¼ è¿™ä¸ªå…¬ç½‘åœ°å€ï¼Œé‚£ä¹ˆå†…ç½‘æœåŠ¡å°±çŸ¥é“äº†è‡ªå·±çš„å…¬ç½‘èº«ä»½äº†ï¼Œåªè¦ç»´æŒä½è¿™ä¸ªæ˜ å°„ï¼Œé‚£ä¹ˆä»»æ„è®¾å¤‡å°±å¯ä»¥é€šè¿‡è®¿é—®è¿™ä¸ªå…¬ç½‘åœ°å€è¾¾åˆ°å†…ç½‘æœåŠ¡äº†ã€‚

å…¶ä¸­`100.80.48.188`è¿™ä¸ªæ˜¯è¿è¥å•†å¤§å†…ç½‘ä¸­çš„åœ°å€ï¼Œå¦‚æœåœ¨åŒä¸€è¿è¥å•†ç½‘ç»œ(ç§»åŠ¨/è”é€š/ç”µä¿¡)ä¸‹ï¼Œæ˜¯å¯ä»¥æ‹¿è¿™ä¸ªåœ°å€è®¿é—®çš„ï¼›è€Œ`189.123.45.67:31580`å°±æ˜¯çœŸæ­£çš„å…¬ç½‘åœ°å€ï¼Œä»»æ„è¿è¥å•†ç½‘ç»œä¸‹çš„è®¾å¤‡éƒ½å¯ä»¥è®¿é—®åˆ°ã€‚

```mermaid
flowchart TB

subgraph äº’è”ç½‘
  a1[è®¾å¤‡A]
  a2[è®¾å¤‡B]
  a3[è®¾å¤‡C]
end

subgraph è¿è¥å•†å±€åŸŸç½‘
  b1[è·¯ç”±å™¨]
end

a1 --> |è®¿é—®189.123.45.67:31580|b1
a2 --> |è®¿é—®189.123.45.67:31580|b1
a3 --> |è®¿é—®189.123.45.67:31580|b1

subgraph å®¶åº­å±€åŸŸç½‘
  c1[è·¯ç”±å™¨]
  c2[LuckyæœåŠ¡å™¨]
end

b1 --> c1
c1 --> |é˜²ç«å¢™åŒºåŸŸè½¬å‘|c2

```

ä»å¤§çš„è§’åº¦çœ‹ï¼Œå¤–éƒ¨ç½‘ç»œè®¿é—®åˆ°å†…ç½‘çš„è¿‡ç¨‹æ˜¯è¿™æ ·ï¼Œè€Œå†…ç½‘ä¸­åˆå¦‚ä½•å°†è¯·æ±‚è½¬å‘åˆ°å®é™…æä¾›æœåŠ¡çš„æœºå™¨ä¸Šå‘¢ï¼Ÿ

```mermaid
flowchart TB

subgraph å®¶åº­å±€åŸŸç½‘
  b1[è·¯ç”±å™¨]
  b2[æœåŠ¡å™¨192.168.0.8]
end

a1[å…¬ç½‘è®¾å¤‡] --> |é€šè¿‡å…¬ç½‘è¯·æ±‚189.123.45.67:31580|b1
b1 --> |æµé‡ä»7788ç«¯å£è½¬å‘åˆ°192.168.0.8:8080|b2

```

è¿™é‡Œè¦è¯´åæ˜çš„ä¸€ä¸‹ï¼Œæˆ‘çš„ Lucky æ˜¯éƒ¨ç½²åœ¨ä¸»è·¯ç”±çš„ OpenWrt ä¸Šï¼Œå…‰çŒ«æ¡¥æ¥ç”¨ä¸»è·¯ç”±æ‹¨å·ã€‚å¦‚æœä½ ä¸èƒ½è®¾ç½®å…‰çŒ«æ¡¥æ¥ï¼Œæˆ–è€… Lucky æ²¡æœ‰éƒ¨ç½²åœ¨ä¸»è·¯ç”±ä¸Šï¼Œé‚£å°±éœ€è¦ç”¨åˆ° DMZ æˆ–è€… Upnp æŠŠ Lucky éœ€è¦ç©¿é€çš„ç«¯å£æ˜ å°„åˆ°æ‹¨å·è®¾å¤‡ä¸Šã€‚  
ä¸¾ä¾‹ï¼šé€šè¿‡ Lucky è®¾ç½® STUN ç©¿é€æ—¶ï¼Œè¦æŒ‡å®šä¸€ä¸ª`ç©¿é€é€šé“æœ¬åœ°ç«¯å£`ï¼Œå‡å¦‚æ˜¯`7788`ã€‚è¿™ä¸ªæ„æ€æ˜¯ï¼Œç”±äºå…¬ç½‘çš„ ip å’Œ port æ˜¯åŠ¨æ€çš„ã€éšæœºçš„ï¼ŒæŒ‡ä¸å®šä»€ä¹ˆæ˜¯å¦å°±ä¼šå˜çš„ï¼Œä½†æ˜¯æœ¬åœ°å¾—ç›‘å¬ä¸€ä¸ªå›ºå®šçš„ç«¯å£ï¼Œé‚£ä¹ˆå…¬ç½‘æµé‡é€šè¿‡`31580`è¿™ä¸ªéšæœºç«¯å£è®¿é—®è¿›æ¥ï¼Œæµé‡åˆ°äº†è·¯ç”±å™¨åå®é™…æ˜¯åˆ°äº†`eth0`è¿™ä¸ªç½‘å¡çš„`7788`ç«¯å£ã€‚

è·¯ç”±å™¨ä¸Šé€šå¸¸éƒ½å¯ä»¥çœ‹åˆ°`WAN`å£å’Œ`LAN`å£ï¼Œå…¶ä¸­`WAN`å£æ¥çš„æ˜¯å…‰çŒ«ï¼Œè¿æ¥åˆ°çš„æ˜¯å¤–éƒ¨ç½‘ç»œï¼Œè€Œå¤–éƒ¨æµé‡è¿›æ¥ä¹Ÿæ˜¯åˆ°è¾¾äº†`eth0`ç½‘å¡ï¼Œå½“æ‹¨å·ä¸Šç½‘æˆåŠŸæ—¶ï¼Œè¿™ä¸ªç½‘å¡å°±ä¼šè¢«è¿è¥å•†åˆ†é…ä¸€ä¸ª ip(100.80.48.188)ï¼›`LAN`å£æ˜¯å†…ç½‘äº¤äº’çš„ç½‘å£ï¼Œå¯¹åº”çš„ç½‘å¡åé€šå¸¸æ˜¯`eth1`ï¼Œå®ƒçš„ ip é€šå¸¸æ˜¯é™æ€çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸å¸¸è®¾ç½®çš„ 192.168.0.1ã€‚

æˆ‘ä»¬å†…ç½‘ä¸­çš„è®¾å¤‡é€šå¸¸éƒ½æ˜¯ 192.168.0.xï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå’Œ`eth1`ç½‘å¡æ˜¯é€šçš„ï¼Œä½†åˆšåˆšæˆ‘ä»¬è¯´å¤–éƒ¨æµé‡æ˜¯æ‰“åˆ°äº†`eth0`çš„ 7788 ç«¯å£ã€‚é‚£æˆ‘ä»¬å°±éœ€è¦æŠŠ`eth0`çš„ 7788 ç«¯å£ä¸Šåˆ°æµé‡è½¬å‘åˆ°`eth1`ä¸ŠæŸä¸ª ip çš„æŸä¸ªç«¯å£ä¸Šï¼Œè¿™ä¸ªè½¬å‘æ“ä½œå¯ä»¥åœ¨è·¯ç”±å™¨ä¸Šçš„é˜²ç«å¢™è®¾ç½®`ç«¯å£è½¬å‘`ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®© Lucky å†…éƒ¨è‡ªè¡Œè½¬å‘ï¼Œä½†æ¨èä½¿ç”¨é˜²ç«å¢™é‚£çš„`ç«¯å£è½¬å‘`ï¼Œå› ä¸ºé‚£æ˜¯å†…æ ¸çº§çš„è½¬å‘ï¼Œæ€§èƒ½ä¼šæ›´é«˜ä¸€äº›ï¼Œèµ„æºå ç”¨ä¹Ÿä¼šæ›´ä½ä¸€äº›ã€‚

**é‡è¦**ï¼š==Lucky æœåŠ¡åƒä¸‡ä¸èƒ½ç»è¿‡ä»»ä½•ç½‘ç»œä»£ç†ï¼Œå³ä½¿æŠŠæ¨¡å¼è®¾ç½®ä¸ºç›´è¿ä¹Ÿä¸è¡Œï¼Œå› ä¸ºä»£ç†è½¯ä»¶ä¸ºäº†åšè§„åˆ™åˆ†æµï¼Œé€šå¸¸ä¼šæ¥ç®¡æ‰€æœ‰çš„ DNS è¯·æ±‚ï¼Œç»Ÿä¸€è¿”å› fakeipï¼Œè¿™ä¼šå¯¼è‡´ Lucky çš„ STUN ç©¿é€æ— æ³•è·å–åˆ°æ­£ç¡®çš„å…¬ç½‘ ip==ã€‚

## 2. DDNSåˆ†æµ

Lucky çš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œé™¤äº†å¯ä»¥å¸®æˆ‘ä»¬è·å–åˆ°å…¬ç½‘åœ°å€ï¼Œå¯ä»¥åš DDNS å°†å…¬ç½‘ ip åŒæ­¥åˆ° DNS è®°å½•ä¸­ã€‚å‡è®¾æˆ‘ä»¬ä¸Šé¢å‡†å¤‡çš„åŸŸåæ˜¯`happy.de5.net`ï¼Œå¦‚æœæŠŠipv4 å’Œ ipv6 çš„åœ°å€éƒ½è®°å½•åˆ°`happy.de5.net`å’Œ`*.happy.de5.net`ï¼Œåˆ°æ—¶å€™å…¬ç½‘è¯¥å¦‚ä½•è®¿é—®ï¼Ÿ  
åœ¨å½“å‰çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ STUN æ‹¿åˆ°çš„ ipv4 å…¬ç½‘ï¼Œåœ°å€å’Œç«¯å£éƒ½æ˜¯åŠ¨æ€çš„ï¼Œè€ŒéåŸç”Ÿçš„å…¬ç½‘åœ°å€ï¼Œä½† ipv6 çš„å…¬ç½‘åœ°å€æ˜¯åŸç”Ÿçš„ã€‚  
å‡è®¾å†…ç½‘ä¸­åä»£æœåŠ¡ç›‘å¬äº†ç«¯å£ 666 è½¬å‘åˆ°åç«¯çš„ 8080 ç«¯å£ï¼Œå¦‚æœå¤–ç½‘è®¾å¤‡ç”¨ ipv6 åœ°å€è®¿é—®æ—¶ï¼Œå°±åº”è¯¥ç”¨`https://happy.de5.net:666`ï¼Œé€šè¿‡å›ºå®šçš„ç«¯å£å°±å¯ä»¥äº†ï¼›ä½†æ˜¯å¦‚æœå¤–ç½‘ç”¨çš„æ˜¯ ipv4 è®¿é—®æ—¶ï¼Œå°±åº”è¯¥ç”¨`https://happy.de5.net:31580`ï¼Œé€šè¿‡éšæœºç«¯å£è®¿é—®ï¼Œå¹¶ä¸”è¿™ä¸ªéšæœºç«¯å£è¿˜æ˜¯ä¼šå˜çš„ã€‚å¯æ˜¯å¤–ç½‘è®¾å¤‡ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨é€‰æ‹©ç”¨ ipv4 è¿˜æ˜¯ ipv6 å‘èµ·è¯·æ±‚ï¼Œè¿™å–å†³äºè®¾å¤‡æ‰€å¤„çš„ç½‘ç»œç¯å¢ƒã€‚è€Œé€šå¸¸å®¶ç”¨è·¯ç”±å™¨çš„ ipv6 å¼€å…³æ˜¯å…³é—­çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å°±æ‹¿ä¸åˆ° ipv6 åœ°å€ï¼Œåˆ«äººæ— æ³•é€šè¿‡ ipv6 è®¿é—®ä½ ï¼Œè€Œæ²¡æœ‰ ipv6 åœ°å€çš„è®¾å¤‡æ›´æ˜¯æ— æ³•è®¿é—®ä½ ã€‚

æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œå¯ä»¥è®¾ç½® SRV è®°å½•å•Šï¼Œæ”¯æŒåŒæ—¶è®°å½• ip å’Œ ç«¯å£å·ï¼Œç¡®å®æ˜¯ï¼ŒLucky ä¹Ÿæ”¯æŒ SRV è®°å½•ï¼Œä½†é—®é¢˜æ˜¯ï¼šä¸æ˜¯æ‰€æœ‰çš„è®¾å¤‡éƒ½æ”¯æŒæŸ¥è¯¢ SRV è®°å½•ï¼Œæ¯”å¦‚æµè§ˆå™¨å°±ä¸ä¼šï¼Œå®ƒåªä¼šæ‰¾ A/AAAA è®°å½•ï¼Œä¹Ÿå°±æ˜¯å»æŸ¥è¯¢ä½ çš„ ipv4/ipv6 åœ°å€ï¼Œå¦‚æœæŸ¥ä¸åˆ°è®°å½•ï¼Œé‚£å°±æŠ¥é”™ã€‚

> ä¼¼ä¹æ²¡æœ‰ä¼˜è§£æ–¹æ¡ˆäº†ï¼Ÿ

åˆ«ç€æ€¥ï¼Œæˆ‘ä»¬æ¢ä¸ªè§’åº¦æƒ³æƒ³ï¼Œæ—¢ç„¶åˆåœ¨ä¸€èµ·ä¸è¡Œï¼Œé‚£å¹²è„†å°±æŠŠ ipv4 å’Œ ipv6 åˆ†å¼€æ¥è®¾ç½®ï¼Œç„¶åå¤–éƒ¨è¯·æ±‚æ—¶ç»Ÿä¸€ç”¨ä¸€ä¸ªå…¥å£ï¼Œæ ¹æ®æ¥æº ip ç±»å‹å°†è¯·æ±‚å®é™…æ‰“åˆ°æˆ‘ä»¬çš„ ipv4 æˆ– ipv6 åœ°å€ä¸Šå»ã€‚è¿™ä¸ªæ„æ€ä¸å°±å’Œåå‘ä»£ç†å·®ä¸å¤šäº†å—ï¼ŸOkï¼Œæ—¢ç„¶æƒ³æ¸…æ¥šäº†ï¼Œé‚£å°±å¼€å§‹å¹²ã€‚

> ç”³è¯·è¯ä¹¦åŠ DDNS

Lucky ç¡®å®å¾ˆå¼ºå¤§ï¼Œä½ å¯èƒ½éœ€è¦çš„ç½‘ç»œç›¸å…³çš„ä¸œè¥¿ï¼Œå®ƒéƒ½æä¾›ç»™ä½ äº†ï¼ŒåŒ…æ‹¬è¯ä¹¦ç”³è¯·åŠç»­æœŸã€‚æ“ä½œèµ·æ¥éå¸¸ç®€å•ï¼Œå…·ä½“çœ‹å¼€å¤´æåˆ°çš„æ–‡ç« ï¼Œè¿™é‡Œåªè¯´æ€è·¯ã€‚

æˆ‘ä»¬åˆ†åˆ«ä¸º`*.v4.happy.de5.net`å’Œ`*.v6.happy.de5.net`è¿™ä¸¤ä¸ªæ³›åŸŸåç”³è¯·è¯ä¹¦ï¼Œå‰ç¼€å¯ä»¥éšæ„ï¼Œè¿™é‡Œç”¨`v4`å’Œ`v6`ä¸»è¦æ˜¯ä¸ºäº†è§åçŸ¥æ„ã€‚ç„¶ååˆ©ç”¨ Lucky æä¾›çš„ DDNS åŠŸèƒ½ï¼Œå°† ipv4 åœ°å€è§£æåˆ°`*.v4.happy.de5.net`ï¼Œå°† ipv6 åœ°å€è§£æåˆ°`*.v6.happy.de5.net`ã€‚==æ³¨æ„==ï¼šä¸è¦å‹¾é€‰`æŒ‡å®šä»£ç†çŠ¶æ€`ã€‚å¦‚æœå‹¾é€‰äº†ï¼Œåœ¨ Cloudflare ä¸Šæ‰˜ç®¡åŸŸåçš„ DNS è®°å½•å°±ä¼šè¢«ä»£ç†ï¼Œæ˜¾ç¤ºä¸€ä¸ªé»„è‰²çš„äº‘æœµï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„`å°é»„äº‘`ã€‚

> ä¸ºä»€ä¹ˆä¸è¦å¼€å¯å°é»„äº‘ï¼Ÿ

ä¸€æ—¦å¼€å¯äº†å°é»„äº‘ï¼Œä½ çš„ DNS è®°å½•å°±ä¼šè¢« Cloudflare ä»£ç†ï¼Œè¡¨ç°ä¸ºï¼šå½“ä½  ping `v4.happy.de5.net` æˆ– `v6.happy.de5.net` çš„ä»»æ„å­åŸŸåæ—¶ï¼Œå¾—åˆ°çš„æ˜¯ Cloudflare çš„æ³›ipï¼Œè€Œéä½ è‡ªå·±çš„çœŸå®ipã€‚å¥½å¤„æ˜¯å¯ä»¥éšè—ä½ çš„çœŸå® ipï¼Œå¹¶ä¸”äº«å— cloudflare å¸¦æ¥çš„å®‰å…¨é˜²æŠ¤ï¼Œåå¤„æ˜¯æ”¯æŒè®¿é—®çš„ç«¯å£æœ‰é™ï¼Œstun æ‹¿åˆ°çš„å…¬ç½‘ç«¯å£éƒ½æ˜¯éšæœºçš„ï¼Œå¾ˆå¯èƒ½å°±æ˜¯ cloudflare ä¸æ”¯æŒçš„ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½è¢« workers å’Œ pages è®¿é—®ã€‚  
å½“å¼€å¯äº†å°é»„äº‘æ—¶ï¼Œä½ çš„æœåŠ¡å™¨å¯¹äº cloudflare æ¥è¯´å°±æ˜¯æºç«™ï¼Œå…¬ç½‘è¯·æ±‚åˆ° cloudflareï¼Œcloudflare åˆ°æºç«™çš„è¿™ä¸ªè¿‡ç¨‹å«åšâ€œå›æºâ€ã€‚

## 3. é‡å®šå‘è§„åˆ™

å¦‚æœè¯´ä¸Šä¸€ä¸ªæ­¥éª¤æ˜¯åˆ†ç¦»ï¼Œè¿™ä¸ªæ­¥éª¤å°±æ˜¯åˆå¹¶ã€‚é€šè¿‡è®¿é—®ä¸€ä¸ªåŸŸå https://ok.happy.de5.netï¼Œæ ¹æ®è®¿é—®è€…çš„ ip ç±»å‹ï¼Œæµè§ˆå™¨è‡ªåŠ¨é‡å®šå‘åˆ° https://ok.v4
.happy.de5.net:31580 æˆ– https://ok.v5.happy.de5.net:666ã€‚è¦å®ç°è¿™ä¸ªæ•ˆæœå°±å¾—åˆ©ç”¨ Cloudflare çš„`é‡å®šå‘è§„åˆ™`ã€‚

ç‚¹å‡»æ‰˜ç®¡åœ¨ Cloudflare ä¸Šçš„åŸŸå`happy.de5.net`ï¼Œæ¥ç€åœ¨å·¦ä¾§èœå•æ‰¾åˆ°`è§„åˆ™`->`æ¦‚è¿°`ï¼Œç‚¹å‡»`åˆ›å»ºè§„åˆ™`ã€‚  
æˆ‘ä»¬å¯ä»¥ä¸º ipv4 å’Œ ipv6 åˆ†åˆ«åˆ›å»ºè§„åˆ™ã€‚

### 3.1 åˆ›å»º ipv4 é‡å®šå‘è§„åˆ™

**ç¼–è¾‘å•ä¸€é‡å®šå‘**

è§„åˆ™åç§°ï¼šhome-redirect-v4

**å¦‚æœä¼ å…¥è¯·æ±‚åŒ¹é…â€¦**

é€‰æ‹©`è‡ªå®šä¹‰ç­›é€‰è¡¨è¾¾å¼`

**å½“ä¼ å…¥è¯·æ±‚åŒ¹é…æ—¶...**

|å­—æ®µ|è¿ç®—ç¬¦|å€¼|æ¡ä»¶|
|:-:|:-:|:-:|:-:|
|ä¸»æœºå|ç­‰äº|*.happy.de5.net|And|
|IPæºåœ°å€|åŒ…å«ä»¥ä¸‹å„é¡¹|0.0.0.0/0||

è¡¨è¾¾å¼é¢„è§ˆ
> (http.host eq "*.happy.de5.net" and ip.src in {0.0.0.0/0})

**åˆ™...**

URL é‡å®šå‘

|ç±»å‹|è¡¨è¾¾å¼|çŠ¶æ€ç |
|:-:|:-:|:-:|
|åŠ¨æ€|wildcard_replace(http.request.full_uri, "https://\*.happy.de5.net/\*", "https://\${1}.v4.happy.de5.net:31580/\${2}")|307|


å‹¾é€‰`ä¿ç•™æŸ¥è¯¢å­—ç¬¦ä¸²`

---

ä¸Šè¿°è¯´æ˜ï¼š

1. ip æ¥æºå€¼ä¸º 0.0.0.0/0ï¼Œå°±è¡¨ç¤ºåŒ¹é…æ‰€æœ‰çš„ ipv4 åœ°å€ã€‚
2. https://\*.happy.de5.net/\* è¿™é‡Œçš„ \* å°±æ˜¯å ä½ç¬¦ï¼Œå¯ä»¥æŒ‡ä»£ä»»æ„å­—ç¬¦ä¸²ã€‚https://\${1}.v4.happy.de5.net:31580/\${2} ï¼Œè¿™é‡Œ \${1} å°±è¡¨ç¤ºå¼•ç”¨ç¬¬ 1 ä¸ª \* çš„å†…å®¹ï¼Œ ${2} è¡¨ç¤ºå¼•ç”¨ç¬¬ 2 ä¸ª \* çš„å†…å®¹ï¼Œä»¥æ­¤ç±»æ¨ã€‚
3. 307/302 è¡¨ç¤ºä¸´æ—¶é‡å®šå‘ï¼Œ 305/301 è¡¨ç¤ºæ°¸ä¹…é‡å®šå‘ã€‚å¦‚æœæ°¸ä¹…é‡å®šå‘çš„è¯ï¼Œæµè§ˆå™¨ä¼šè®°ä½é‡å®šå‘åçš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬å½“ç„¶è¦ç”¨ä¸´æ—¶é‡å®šå‘ã€‚è€Œ 302 æ˜¯å†å²é—ç•™äº§ç‰©ï¼Œä¸è§„èŒƒï¼Œæ— è®ºé‡å®šå‘å‰æ˜¯å“ªç§è¯·æ±‚æ–¹å¼ï¼Œé‡å®šå‘åéƒ½å˜æˆäº† GET è¯·æ±‚ï¼Œè¿™å°±å¯èƒ½ä¼šä¸¢å¤±è¯·æ±‚ bodyï¼Œè€Œ 307 å°±å¾ˆå¥½çš„ä¿ç•™äº†åŸå§‹çš„è¯·æ±‚æ–¹å¼ã€‚

**é‡å®šå‘è§„åˆ™è¿™é‡Œæœ‰ä¸ªé—®é¢˜**

ä¸¾ä¾‹ï¼ŒåŸå§‹è¯·æ±‚ï¼šhttps://okk.happy.de5.net/bestï¼Œé‡å®šå‘åï¼šhttps://okk.v4.happy.de5.net/best:31580ã€‚  
31580 æ˜¯ STUN æ‹¿åˆ°çš„åŠ¨æ€å…¬ç½‘ç«¯å£ï¼Œä¸€æ—¦å‘ç”Ÿäº†å˜åŒ–è¿™æ¡é‡å®šå‘è§„åˆ™å°±èµ°ä¸é€šäº†ã€‚

å¥½åœ¨ Cloudflare çš„è®¾ç½®éƒ½æä¾›äº† api æ–¹å¼ä¿®æ”¹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨ STUN çš„ WebHook å¤„æ¥å‘èµ·ä¸€ä¸ªè¯·æ±‚æ¥ä¿®æ”¹é‡å®šå‘è§„åˆ™ã€‚

å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1. è·å– Api ä»¤ç‰Œ

ç‚¹å‡»å³ä¸Šè§’`ä¸ªäººç®€ä»‹`->`é…ç½®æ–‡ä»¶`ï¼Œå†ç‚¹å‡»å·¦ä¾§èœå•ä¸­çš„`APIä»¤ç‰Œ`ï¼Œåœ¨`APIä»¤ç‰Œ`åŒºåŸŸç‚¹å‡»`åˆ›å»ºä»¤ç‰Œ`->`è‡ªå®šä¹‰ä»¤ç‰Œ`ã€‚

ä»¤ç‰Œåç§°ï¼šéšæ„

æƒé™ï¼š  
`è´¦æˆ·` `è´¦æˆ·è§„åˆ™é›†` `ç¼–è¾‘`  
`åŒºåŸŸ` `å•ä¸€é‡å®šå‘` `ç¼–è¾‘`

å¸æˆ·èµ„æºï¼š  
`åŒ…æ‹¬` `{ä½ çš„è´¦æˆ·}`

åŒºåŸŸèµ„æºï¼š  
`åŒ…æ‹¬` `ç‰¹å®šåŒºåŸŸ` `happy.de5.net`

æ¥ç€ä¿å­˜å¹¶è®°ä¸‹ Apiä»¤ç‰Œã€‚

2. è·å–åŒºåŸŸ(Zone)ID

ç‚¹å‡»æ‰˜ç®¡çš„åŸŸåï¼Œå°†é¡µé¢æ‹‰åˆ°æœ€ä¸‹é¢ï¼Œå°±å¯ä»¥çœ‹åˆ°`åŒºåŸŸID`ã€‚

3. è·å–é‡å®šå‘è§„åˆ™é›†ID

å‘èµ·å¦‚ä¸‹è¯·æ±‚ï¼š
```plain
GET https://api.cloudflare.com/client/v4/zones/{åŒºåŸŸID}/rulesets
Authorization: Bearer {Apiä»¤ç‰Œ}
```

åœ¨å“åº”ç»“æœä¸­æœç´¢`http_request_dynamic_redirect`ï¼Œè¿™ä¸€é¡¹çš„ id å°±æ˜¯é‡å®šå‘çš„`è§„åˆ™é›†ID`ã€‚

4. è·å–é‡å®šå‘è§„åˆ™

å‘èµ·å¦‚ä¸‹è¯·æ±‚ï¼š
```plain
GET https://api.cloudflare.com/client/v4/zones/{åŒºåŸŸID}/rulesets/{è§„åˆ™é›†ID}
Authorization: Bearer {Apiä»¤ç‰Œ}
```

åœ¨å“åº”ç»“æœä¸­å°±å¯ä»¥çœ‹åˆ°åˆšåˆšè®¾ç½®çš„é‡å®šå‘è§„åˆ™`home-redirect-v4`ï¼Œè¿™ä¸€é¡¹çš„ id å°±æ˜¯`è§„åˆ™ID`ã€‚

5. ä¿®æ”¹é‡å®šå‘è§„åˆ™

å‘èµ·å¦‚ä¸‹è¯·æ±‚ï¼š
```plain
PATCH https://api.cloudflare.com/client/v4/zones/{åŒºåŸŸID}/rulesets/{è§„åˆ™é›†ID}/{è§„åˆ™ID}
Authorization: Bearer {Apiä»¤ç‰Œ}

{
  "description": "home-redirect-v4",
  "enabled": true,
  "expression": "(http.host eq \"*.happy.de5.net\" and ip.src in {0.0.0.0/0})",
  "action": "redirect",
  "action_parameters": {
    "from_value": {
      "preserve_query_string": true,
      "status_code": 307,
      "target_url": {
        // å‡è®¾ STUN è·å–åˆ°çš„æœ€æ–°å…¬ç½‘ç«¯å£æ˜¯ 25778
        "expression": "wildcard_replace(http.request.full_uri, \"https://*.happy.de5.net/*\", \"https://${1}.v4.happy.de5.net:25778/${2}\")"
      }
    }
  }
}
```

### 3.2 åˆ›å»º ipv6 é‡å®šå‘è§„åˆ™

**ç¼–è¾‘å•ä¸€é‡å®šå‘**

è§„åˆ™åç§°ï¼šhome-redirect-v6

**å¦‚æœä¼ å…¥è¯·æ±‚åŒ¹é…â€¦**

é€‰æ‹©`è‡ªå®šä¹‰ç­›é€‰è¡¨è¾¾å¼`

**å½“ä¼ å…¥è¯·æ±‚åŒ¹é…æ—¶...**

|å­—æ®µ|è¿ç®—ç¬¦|å€¼|æ¡ä»¶|
|:-:|:-:|:-:|:-:|
|ä¸»æœºå|ç­‰äº|*.happy.de5.net|And|
|IPæºåœ°å€|åŒ…å«ä»¥ä¸‹å„é¡¹|2000::/3||

è¡¨è¾¾å¼é¢„è§ˆ
> (http.host eq "*.happy.de5.net" and ip.src in {2000::/3})

**åˆ™...**

URL é‡å®šå‘

|ç±»å‹|è¡¨è¾¾å¼|çŠ¶æ€ç |
|:-:|:-:|:-:|
|åŠ¨æ€|wildcard_replace(http.request.full_uri, "https://\*.happy.de5.net/\*", "https://\${1}.v6.happy.de5.net:666/\${2}")|307|


å‹¾é€‰`ä¿ç•™æŸ¥è¯¢å­—ç¬¦ä¸²`

---

è¯´æ˜ï¼šå’Œ ipv4 çš„é‡å®šå‘è§„åˆ™å·®ä¸å¤šï¼Œ`2000::/3`åŒ…å«äº†æ‰€æœ‰çš„ ipv6ï¼Œè¡¨ç¤ºåŒ¹é…æ‰€æœ‰çš„ ipv6 åœ°å€ã€‚ä½†é‡å®šå‘çš„ç«¯å£å¯ä»¥æ˜¯å›ºå®šçš„ 666ï¼Œå› ä¸º ipv6 æ˜¯åŸç”Ÿçš„å…¬ç½‘ ipï¼Œæ‰€ä»¥å°±ä¸éœ€è¦åƒ ipv4 é‚£æ ·é€šè¿‡ api æ¥ä¿®æ”¹è§„åˆ™äº†ã€‚å½“ç„¶ï¼Œå¦‚æœæƒ³ä¿®æ”¹ä¹Ÿè¡Œï¼Œè·Ÿä¿®æ”¹ ipv4 é‡å®šå‘è§„åˆ™ä¸€æ ·çš„æ–¹å¼ã€‚

å‘èµ·å¦‚ä¸‹è¯·æ±‚ï¼š
```plain
PATCH https://api.cloudflare.com/client/v4/zones/{åŒºåŸŸID}/rulesets/{è§„åˆ™é›†ID}/{è§„åˆ™ID}
Authorization: Bearer {Apiä»¤ç‰Œ}

{
  "description": "home-redirect-v6",
  "enabled": true,
  "expression": "(http.host eq \"*.happy.de5.net\" and ip.src in {2000::/3})",
  "action": "redirect",
  "action_parameters": {
    "from_value": {
      "preserve_query_string": true,
      "status_code": 307,
      "target_url": {
        "expression": "wildcard_replace(http.request.full_uri, \"https://*.happy.de5.net/*\", \"https://${1}.v6.happy.de5.net:666/${2}\")"
      }
    }
  }
}
```

### 3.3 è®¾ç½® DNS è®°å½•

æœ€åè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œæ‰‹åŠ¨ä¸º`happy.de5.net`è®¾ç½®ä¸¤ä¸ª DNS è®°å½•ã€‚

|ç±»å‹|åç§°|å†…å®¹|ä»£ç†çŠ¶æ€|TTL|
|:-:|:-:|:-:|:-:|:-:|
|A|@|192.0.2.1|å¯ç”¨|è‡ªåŠ¨|
|A|*|192.0.2.1|å¯ç”¨|è‡ªåŠ¨|

è¿™ä¸¤ä¸ªè®°å½•ä¸€å®šè¦æ‰“å¼€å°é»„äº‘ï¼Œæ‰èƒ½è§¦å‘é‡å®šå‘è§„åˆ™ã€‚å…¶ä¸­`192.0.2.1`æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„ IP åœ°å€ï¼Œåœ¨ RFC 5737 è§„èŒƒä¸­ï¼Œå®ƒæ˜¯ä»…ç”¨äºæ¼”ç¤ºã€ä¸¾ä¾‹ã€å†™ä¹¦çš„ä¸€ä¸ªåœ°å€ï¼Œä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¸»æœºåœ°å€ã€‚ä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸º 0.0.0.0ï¼Œéšä¾¿éƒ½å¯ä»¥ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯ä¹¦åªç”³è¯·`*.v4.happy.de5.net`å’Œ`*.v5.happy.de5.net`ï¼Œè€Œ`happy.de5.net`å’Œ`*.happy.de5.net`ä¸éœ€è¦è¯ä¹¦ï¼Œå› ä¸ºå®ƒä»¬æŒ‡å‘çš„ä¸æ˜¯æœ‰æ•ˆçš„ä¸»æœºï¼ŒTCP ä¸‰æ¬¡æ¡æ‰‹éƒ½å®Œæˆä¸äº†ï¼Œæ›´åˆ«æåé¢çš„ Client Hello æ‹¿è¯ä¹¦äº†ã€‚æ ¹åŸŸåçš„ä½œç”¨ä»…ä»…æ˜¯ç”¨æ¥åšé‡å®šå‘ã€‚

---

ç»è¿‡ä¸Šé¢çš„æ“ä½œï¼Œæˆ‘ä»¬å°±å¯ä»¥åšåˆ°é€šè¿‡æµè§ˆå™¨è®¿é—®ä¸€ä¸ªåœ°å€ï¼Œè‡ªåŠ¨é‡å®šå‘åˆ°ä¸åŒçš„å­åŸŸï¼Œæ”¯æŒåŒæ ˆç½‘ç»œè®¿é—®ã€‚

ä½†æ˜¯æœ‰ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼åªé€‚åˆç”¨äºæµè§ˆå™¨ç¯å¢ƒï¼Œå¯¹äºä¸€äº› api æœåŠ¡æ¥è¯´ï¼Œä½ è¿”å›ç»™å®ƒ 302/307 æ ¹æœ¬ä¸è¡Œï¼Œå®ƒåªè®¤ 200ï¼Œä¸æ˜¯å°±æŠ¥é”™ã€‚å¹¶ä¸”è¿™è¿˜å¯èƒ½æœ‰èµ„æºè·¨åŸŸé—®é¢˜ã€‚æµè§ˆå™¨åœ°å€æ æœ‰ç«¯å£å·ä¸‘ä¸è¯´ï¼Œè¿˜ä¼šæš´éœ²çœŸå®çš„ ip åœ°å€ã€‚

é‚£æˆ‘ä»¬å°±æ¢ä¸€ç§æ–¹å¼ï¼Œç»“åˆ worker æ¥åšã€‚

## 4. Worker åä»£
### 4.1 Workers è¯´æ˜

Cloudflare è¿™ä¸ªèµ›åšå–„äººæä¾›äº† Workers&Pagesã€‚Workers å¯ä»¥åœ¨è¾¹ç¼˜èŠ‚ç‚¹ä¸Šæ‰§è¡Œ Serverless å‡½æ•°ï¼ŒPages åˆ™å¯ä»¥æ‰˜ç®¡é™æ€ç½‘ç«™ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ‰§è¡Œ Serverless å‡½æ•°ã€‚

Pages çš„åŠŸèƒ½å¾ˆå¥½ç†è§£ï¼Œå®ƒå°±ç±»ä¼¼äº GitHub Pagesã€Vercelã€Netlify å¯ä»¥æ‰˜ç®¡é™æ€ç½‘ç«™ï¼Œä¸è¿‡ GitHub Pages ä¸èƒ½æ‰§è¡Œå‡½æ•°ï¼ŒVercel å’Œ Netlify å¯ä»¥ã€‚å½“å‰è¿™ä¸ªåšå®¢å°±æ˜¯æ‰˜ç®¡åœ¨ Vercel å’Œ Netlify ä¸Šã€‚

Workers çš„åŠŸèƒ½ä¼¼ä¹æœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œä»€ä¹ˆæ˜¯è¾¹ç¼˜èŠ‚ç‚¹ï¼Ÿä»€ä¹ˆæ˜¯ Serverlessï¼Ÿèƒ½æ‰§è¡Œä»€ä¹ˆå‡½æ•°ï¼Ÿ

> ä»€ä¹ˆæ˜¯è¾¹ç¼˜èŠ‚ç‚¹ï¼Ÿ

é¦–å…ˆâ€œèŠ‚ç‚¹â€æŒ‡çš„å°±æ˜¯ Cloudflare çš„æœåŠ¡å®ä¾‹ã€‚Cloudflare åœ¨å…¨çƒå„åœ°éƒ½æœ‰æœºæˆ¿ï¼Œå› æ­¤èŠ‚ç‚¹ä¹Ÿå°±éå¸ƒå…¨çƒã€‚

â€œè¾¹ç¼˜â€æŒ‡çš„å°±æ˜¯ç½‘ç»œä½ç½®è·ç¦»ä½ æœ€è¿‘çš„åœ°æ–¹ï¼Œå› æ­¤â€œè¾¹ç¼˜èŠ‚ç‚¹â€æŒ‡çš„å°±æ˜¯åœ¨ç½‘ç»œä½ç½®ä¸Šç¦»ä½ æœ€è¿‘çš„é‚£ä¸ª Cloudflare æœåŠ¡å®ä¾‹ã€‚

å› ä¸ºä½ åœ¨ Workers ä¸Šéƒ¨ç½²çš„å‡½æ•°ï¼ŒCloudflare ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å…¨çƒå„ä¸ªèŠ‚ç‚¹ä¸Šå»ï¼Œå¦‚æœä½ æ²¡åšâ€œWorkerè·¯ç”±è§„åˆ™â€æˆ–å…¶ä»–é˜²æŠ¤ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®åˆ°ä½ çš„å‡½æ•°ã€‚  
å‡è®¾ Cloudflare åœ¨é¦™æ¸¯ã€ä¸œäº¬ã€æ´›æ‰çŸ¶ã€é¦–å°”æœ‰èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹ä¸Šéƒ½ä¼šå­˜åœ¨ä½ çš„å‡½æ•°ï¼Œé¦™æ¸¯æœ‹å‹å¦‚æœè¦è®¿é—®ä½ çš„å‡½æ•°ï¼Œå°±è¿‘åŸåˆ™å°±ä¼šè¯·æ±‚åˆ°é¦™æ¸¯èŠ‚ç‚¹ï¼›ç¾å›½æœ‹å‹å¦‚æœè¦è®¿é—®ä½ çš„å‡½æ•°ï¼Œå°±è¿‘åŸåˆ™å°±ä¼šè¯·æ±‚åˆ°æ´›æ‰çŸ¶èŠ‚ç‚¹ã€‚è¿™ä¹ˆåšçš„å¥½å¤„å¾ˆæ˜æ˜¾ï¼Œå…¨çƒä»»ä½•ä½ç½®çš„äººéƒ½å°±è¿‘è®¿é—®è¾¹ç¼˜èŠ‚ç‚¹ï¼Œèƒ½æœ‰æ•ˆé™ä½å»¶è¿Ÿã€‚

å…¶å®ç±»ä¼¼çš„æˆ‘ä»¬è¿˜å¬è¿‡â€œè¾¹ç¼˜ç½‘å…³â€ï¼Œå°¤å…¶æ˜¯æ™ºèƒ½å®¶å±…ç‰©è”ç½‘åœºæ™¯ä¸‹ï¼Œå„ç§è®¾å¤‡é€šè¿‡WIFIã€è“ç‰™æˆ–è€…Zigbeeäº’è”ï¼Œæ€»å¾—éœ€è¦ä¸€ä¸ªä¸­æ¢(ç›¸å½“äºæŒ‡æŒ¥ä¸­å¿ƒ)ï¼Œè¿™ä¸ªä¸­æ¢å°±æ˜¯ç½‘å…³ï¼Œå› ä¸ºç½‘å…³å¤„äºå†…ç½‘ä¸­ï¼Œåœ¨ç½‘ç»œä¸Šç¦»æˆ‘ä»¬æœ€è¿‘ï¼Œå› æ­¤ä¹Ÿå«åšâ€œè¾¹ç¼˜ç½‘å…³â€ã€‚ 
æˆ‘ä»¬è¿˜å¬è¯´è¿‡â€œè¾¹ç¼˜è®¡ç®—â€å‘¢ï¼Œæ¯”å¦‚ä½ çš„å°çˆ±éŸ³ç®±æˆ–è€…å¤©çŒ«ç²¾çµï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªâ€œè¾¹ç¼˜ç½‘å…³â€ï¼Œå½“æˆ‘ä»¬ç»™å®ƒå‘é€æŒ‡ä»¤ï¼Œæœ‰äº›æ˜¯ç®€å•æŒ‡ä»¤ï¼Œæ¯”å¦‚â€œå®šä¸ªé—¹é’Ÿâ€ã€â€œxxåˆ†é’Ÿåæé†’æˆ‘â€ã€â€œæ‰“å¼€ä¸»ç¯â€ï¼Œè¿™äº›æŒ‡ä»¤éƒ½æ˜¯å°çˆ±éŸ³ç®±è‡ªèº«å°±èƒ½è®¡ç®—å¹¶å®Œæˆçš„ï¼Œå°±æ˜¯â€œè¾¹ç¼˜è®¡ç®—â€ï¼›è€Œå¯¹äºä¸€äº›å¤æ‚æŒ‡ä»¤ï¼Œæ¯”å¦‚â€œæœ€è¿‘çš„å›½é™…å±€åŠ¿â€ã€â€œåˆ†æè¿‡å»ä¸¤å‘¨çš„é»„é‡‘èµ°åŠ¿â€ï¼Œè¿™äº›å°±ä¼šå‘é€åˆ°å°ç±³æœåŠ¡å™¨(äº‘ç«¯)è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯â€œäº‘è®¡ç®—â€ã€‚  
â€œè¾¹ç¼˜è®¡ç®—â€çš„ä¼˜åŠ¿åœ¨äºå¿«ï¼Œå…å»ç½‘ç»œå»¶è¿Ÿå¼€é”€å°±èƒ½å®Œæˆä»»åŠ¡ï¼›â€œäº‘è®¡ç®—â€çš„ä¼˜åŠ¿åœ¨äºå¼ºå¤§ï¼Œèƒ½å®Œæˆæ›´å¤æ‚ä¸”å¤šæ ·æ€§çš„ä»»åŠ¡ã€‚å½“ç„¶åœ¨ AI å‘å±•çš„ä»Šå¤©ï¼Œè¾¹ç¼˜ç½‘å…³çš„ç¡¬ä»¶ä¹Ÿå¯ä»¥å†…ç½®ä¸€äº›å°æ¨¡å‹ï¼Œæ”¯æŒåœ¨æœ¬åœ°åšä¸€äº›å¤æ‚è®¡ç®—å’Œåˆ†æä»»åŠ¡äº†ã€‚

> ä»€ä¹ˆæ˜¯ Serverlessï¼Ÿ

ä¼ ç»Ÿæ„ä¹‰ä¸Šï¼Œæˆ‘ä»¬ç¼–ç å†™äº†å‡ ä¸ªå‡½æ•°ï¼Œæ— è®ºæ˜¯ä»€ä¹ˆè¯­è¨€ï¼Œå¦‚æœè¦æä¾›è®¿é—®ï¼Œå°±å¾—å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç›‘å¬ TCP/UDPï¼Œä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æƒ³æä¾›æœåŠ¡å°±å¾—æœ‰ Serverï¼Œæˆ‘ä»¬è¿˜å¾—ç»´æŒè¿™ä¸ª Server è¿è¡Œï¼Œä¸€æ—¦ Server åœæ­¢ï¼Œå‡½æ•°ä¹Ÿå°±æ— æ³•æ‰§è¡Œäº†ã€‚  
è€Œ Serverless å°±æ˜¯è®©æˆ‘ä»¬ä¸ç”¨åˆ›å»º Serverï¼Œæ›´ä¸ç”¨å…³å¿ƒ Server çš„å­˜åœ¨ï¼Œå‡½æ•°éƒ¨ç½²åˆ° Worker ä¸Šå°±èƒ½æä¾›è®¿é—®ã€‚æ—¢ç„¶è¿ Server çš„ä¸ç”¨åˆ›å»ºï¼Œä¹Ÿå°±æ— éœ€ç»´æŒ Server äº†ã€‚

ä¼ ç»ŸæœåŠ¡å™¨è®¡è´¹æŒ‰ç…§ CPU(è§„æ ¼ã€é¢‘ç‡ã€æ ¸æ•°)ã€å†…å­˜ã€ç¡¬ç›˜ã€å¸¦å®½ã€æµé‡ç­‰å¤šç§ç»´åº¦è®¡è´¹ã€‚ä½ ä¸€æ—¦ä¹°äº†æœåŠ¡å™¨ï¼Œè¿™äº›è´¹ç”¨å°±äº§ç”Ÿäº†ï¼Œå³ä½¿ä½ æ²¡ç”¨æ”¾åœ¨é‚£åƒç°ï¼Œé‚£ä¹Ÿæ˜¯è¦ç»™é’±çš„ï¼Œå› æ­¤æˆæœ¬å°±ç›¸å¯¹è¾ƒé«˜ã€‚  
è€Œ Serverless çš„ CPU(è§„æ ¼ã€é¢‘ç‡ã€æ ¸æ•°)ã€å†…å­˜ã€ç¡¬ç›˜ã€å¸¦å®½ã€æµé‡ç­‰éƒ½æ˜¯å…±äº«çš„ï¼Œå½“ä½ çš„å‡½æ•°éœ€è¦è¿è¡Œï¼ŒCloudflare ä¼šè°ƒåº¦ CPU ç»™ä½ æ‰§è¡Œï¼ŒæŒ‰ç…§æ‰§è¡Œæ—¶é—´æ”¶è´¹ï¼Œä¸æ‰§è¡Œå°±ä¸æ”¶è´¹ï¼Œå…¶ä»–èµ„æºä¹Ÿæ˜¯åŒæ ·çš„ï¼Œç”¨å¤šå°‘èŠ±å¤šå°‘ã€‚è¦æ˜¯ä¸ç”¨æ”¾é‚£åƒç°ï¼Œé‚£å°±ä¸æ”¶ä½ é’±ï¼Œå¯ä»¥è¯´ä¼˜åŠ¿å¾ˆæ˜æ˜¾ã€‚

> èƒ½æ‰§è¡Œä»€ä¹ˆå‡½æ•°ï¼Ÿ

å¯ä»¥ç”¨ Node.js å†™å‡½æ•°ï¼Œæ¯”å¦‚ï¼šæ­£å‘ä»£ç†ã€åå‘ä»£ç†ã€ç®¡ç†ç³»ç»Ÿç­‰ç­‰ï¼Œç»“åˆCloudflare æä¾›çš„å…è´¹ KVã€D1ã€R2 ç­‰å¤šç§å­˜å‚¨æ–¹å¼ï¼Œå¯ä»¥å®ç°æ›´å¤šåŠŸèƒ½ã€‚

### 4.2 èµ„æºé™åˆ¶

Cloudflare çœŸçš„æ˜¯ç›¸å½“æ…·æ…¨ï¼Œå³ä½¿æ˜¯å…è´¹è´¦æˆ·ï¼Œæä¾›çš„èµ„æºä¹Ÿæ˜¯éå¸¸çš„å……è£•ï¼Œä¸ªäººä½¿ç”¨å¾ˆéš¾è§¦åŠä¸Šé™ã€‚

æ¯”å¦‚ï¼ŒWorkers&Pages æ¯æ—¥è¯·æ±‚æœ€å¤§é™é¢ 10W æ¬¡ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯å•ä¸ªè´¦æˆ·ä¸‹æ‰€æœ‰ Workers&Pages çš„è¯·æ±‚æ¬¡æ•°æ€»å’Œã€‚

æ¯ä¸ª Worker ä¸­å‡½æ•°æ‰§è¡Œçš„æœ€å¤§ CPU æ—¶é—´æ˜¯ 10msï¼Œè¿™æ„å‘³ç€åªè¦ä¸æ˜¯åšå¤æ‚çš„åŠ /è§£å¯†ï¼Œæ­»å¾ªç¯ï¼Œæ‰¹é‡è¯»å†™å¤§æ–‡ä»¶ï¼Œå‡ ä¹æ˜¯è¾¾ä¸åˆ°è¿™ä¸ªé™åˆ¶çš„ã€‚è€Œ KV å­˜å‚¨æ›´æ˜¯æ¯æ—¥ 1000æ¬¡å†™æ“ä½œï¼Œ10W æ¬¡è¯»æ“ä½œã€‚

### 4.3 éƒ¨ç½²å‡½æ•°

ä¸ºäº†è§„é¿å‰é¢é‡å®šå‘çš„ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© Worker æ¥åšä¸€ä¸ªåå‘ä»£ç†æœåŠ¡ï¼Œä»£ç å¦‚ä¸‹ï¼š
```js title="_worker.js" :collapsed-lines=15
// å®šä¹‰KVé”®å
const KV_KEY_PORT = "stun_port";

export default {
  async fetch(request, env, ctx) {
    // å¤„ç†POST APIè¯·æ±‚ï¼Œç”¨äºæ›´æ–°ç«¯å£
    const url = new URL(request.url);
    if (request.method === "POST" && url.pathname === "/api/stun") {
      try {
        // éªŒè¯Token
        const authHeader = request.headers.get("Authorization");
        const expectedToken = env.TOKEN;

        if (!authHeader || !expectedToken) {
          return new Response(JSON.stringify({ error: "Unauthorized: Missing token." }), {
            status: 401,
            headers: { "Content-Type": "application/json" },
          });
        }

        const parts = authHeader.split(" ");
        if (parts.length !== 2 || parts[0] !== "Bearer" || parts[1] !== expectedToken) {
          return new Response(JSON.stringify({ error: "Unauthorized: Invalid token." }), {
            status: 401,
            headers: { "Content-Type": "application/json" },
          });
        }

        // è§£æJSONè¯·æ±‚ä½“
        const body = await request.json();
        const port = body.port;

        // éªŒè¯portå€¼
        if (!port || typeof port !== "number" || port < 1 || port > 65535) {
          return new Response(JSON.stringify({ error: "Invalid port number." }), {
            status: 400,
            headers: { "Content-Type": "application/json" },
          });
        }

        // 2. ä¿å­˜åˆ°KV (å¿…é¡»è½¬ä¸ºå­—ç¬¦ä¸²)
        await env.KV_STORE.put(KV_KEY_PORT, port);

        return new Response(JSON.stringify({ code: 0, success: true }), {
          status: 200,
          headers: { "Content-Type": "application/json" },
        });
      } catch (err) {
        return new Response(JSON.stringify({ error: "Processing error: " + err.message }), {
          status: 400,
          headers: { "Content-Type": "application/json" },
        });
      }
    }

    // è·å–å®¢æˆ·ç«¯IP
    const ipHeaders = ["cf-connecting-ip", "x-forwarded-for", "x-real-ip", "true-client-ip"];
    let clientIP = null;
    for (const header of ipHeaders) {
      const ip = request.headers.get(header);
      if (ip) {
        clientIP = header === "x-forwarded-for" ? ip.split(",")[0].trim() : ip;
        break;
      }
    }

    if (!clientIP) {
      return new Response(JSON.stringify({ error: "Bad Request: Unknown client ip." }), {
        status: 400,
        headers: { "Content-Type": "application/json" },
      });
    }

    // 1. æ ¹æ®IPç‰ˆæœ¬ç¡®å®šä¸»åç«¯
    let primaryBackend;
    if (clientIP.includes(":")) {
      primaryBackend = `https://${env.BACKEND_V6}`;
    } else {
      // IPv4åœ°å€ - åŠ¨æ€è·å–ç«¯å£
      const v4Port = await env.KV_STORE.get(KV_KEY_PORT);
      if (v4Port) {
        primaryBackend = `https://${env.BACKEND_V4}:${v4Port}`;
      } else {
        primaryBackend = null;
      }
    }

    // 2. å°è¯•è¯·æ±‚ä¸»åç«¯
    if (primaryBackend) {
      try {
        const reqClone = request.clone();
        return await sendToBackend(reqClone, primaryBackend);
      } catch (err) {
        // ä¸»åç«¯å¤±è´¥ï¼Œç»§ç»­åˆ°å…œåº•é€»è¾‘
      }
    }

    // 3. å…œåº•
    try {
      return await sendToBackend(request, `https://${env.BACKEND_FB}`);
    } catch (fallbackErr) {
      return new Response("Service Unavailable", { status: 503 });
    }
  },
};

async function sendToBackend(originalRequest, backendUrl) {
  const url = new URL(originalRequest.url);
  const targetUrl = new URL(url.pathname + url.search, backendUrl);

  const newReq = new Request(targetUrl, {
    method: originalRequest.method,
    headers: originalRequest.headers,
    body: originalRequest.body,
    redirect: "follow",
    signal: AbortSignal.timeout(5000) // ä½¿ç”¨è¶…æ—¶ä¿¡å·
  });

  newReq.headers.set("Host", targetUrl.hostname);
  
  // å‘é€è¯·æ±‚å¹¶éªŒè¯ç»“æœ
  const response = await fetch(newReq);
  
  // çŠ¶æ€ç ä¸æ˜¯200åˆ™è®¤ä¸ºå¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯è®©è°ƒç”¨æ–¹å¤„ç†
  if (response.status !== 200) {
    throw new Error(`Backend returned non-200 status: ${response.status}`);
  }
  
  return response;
}
```
æ‰“å¼€ Cloudflare ä¸»é¡µä¸‹å·¦ä¾§èœå•`è®¡ç®—å’ŒAI`->`Workers å’Œ Pages`ï¼Œå³ä¸Šè§’`åˆ›å»ºåº”ç”¨ç¨‹åº`ï¼Œåç§°éšæ„ã€‚  
éƒ¨ç½²å®Œåï¼Œåœ¨Workerçš„`è®¾ç½®`->`å˜é‡å’Œæœºå¯†`æ·»åŠ ä¸€ä¸ª`TOKEN`ã€‚ç„¶ååœ¨å·¦ä¾§`å­˜å‚¨å’Œæ•°æ®åº“`->`Workers KV`åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œåç§°éšæ„ã€‚ç„¶ååœ¨åˆ›å»ºçš„ Worker ä¸­`ç»‘å®š`é€‰æ‹©åˆšåˆšåˆ›å»ºçš„ KV å®ä¾‹ï¼Œç»‘å®šåç§°ä¸º`KV_STORE`ã€‚

å»ºè®®å¯ä»¥æ”¾å¼ƒ url é‡å®šå‘é‚£å¥—ç©æ³•ï¼Œé™¤éç‰¹åˆ«éœ€è¦ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç§»é™¤æ‰`happy.de5.net`å’Œ`*.happy.de5.net`è¿™ä¸¤ä¸ª DNS è®°å½•ï¼Œç„¶åå¯ä»¥ç»™ Worker ç»‘å®šä¸€ä¸ªåŸŸåï¼Œå¦‚`happy.de5.net`ï¼Œå¯ä»¥æŠŠ`okk.happy.de5.net`ç»‘å®šç»™ Tunnelã€‚å‰ç«¯åªéœ€è¦è®¿é—®`happy.de5.net`ï¼ŒWorker ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ä»£ç†è¿›è¡Œåç«¯è®¿é—®ï¼ŒåŒæ ·æ”¯æŒåŒæ ˆç½‘ç»œã€‚

å½“ç„¶ï¼Œå®Œå…¨å¯ä»¥æ³¨å†Œå¤šä¸ªåŸŸåï¼Œå› ä¸º`DigitalPlat`å…è´¹å°±å¯ä»¥æ³¨å†Œä¸¤ä¸ªåŸŸåï¼Œ`DNSHE`æœ€å¤šå¯ä»¥å…è´¹æ³¨å†Œ5ä¸ªåŸŸåã€‚

è®¿é—®ç­–ç•¥å¦‚ä¸‹ï¼š
1. å¦‚æœæ˜¯ ipv4 åœ°å€è¿æ¥å°±è½¬å‘åˆ°`*.v4.happy.de5.net`ï¼Œå¦åˆ™è½¬å‘åˆ°`*.v6.happy.de5.net`ã€‚
2. å¦‚æœä¸Šè¿°è¯·æ±‚ä¸æˆåŠŸï¼Œåˆ™è½¬å‘åˆ° Tunnel è¿›è¡Œå…œåº•ã€‚

å› æ­¤ï¼Œå®é™…ä¸Šæˆ‘ä»¬æ˜¯ç»“åˆä½¿ç”¨äº†å†…ç½‘ç©¿é€çš„ 3 ç§æ–¹å¼ï¼šSTUNã€V6ã€Tunnelã€‚

## 5. Tunnel

å‰é¢æåˆ°äº† Cloudflare Tunnelï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§å†…ç½‘ç©¿é€æ–¹å¼ï¼Œé€šè¿‡å†…ç½‘è¿è¡Œ Tunnel å®ä¾‹ï¼Œä¸€ä¸ªå®ä¾‹ä¸‹æœ‰ 4 ä¸ªè¿æ¥å™¨ï¼Œåˆ†åˆ«ä¼šè¿æ¥åˆ°ä¸åŒçš„ Cloudflare èŠ‚ç‚¹ï¼ŒåšæœåŠ¡ç«¯çš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚Tunnel è‡ªèº«è¿˜æä¾›äº†å®¢æˆ·ç«¯é«˜å¯ç”¨çš„æ–¹æ¡ˆï¼Œåªè¦ç”¨ç›¸åŒçš„é…ç½®èµ·å¤šä¸ª Tunnel å®ä¾‹ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨ç®¡ç†è¿æ¥ï¼Œå•èŠ‚ç‚¹æ•…éšœè½¬ç§»ã€‚

ä¸‹è½½[Tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/downloads/)å¹¶åœ¨å†…ç½‘ä¸­ä»»æ„ä¸€å°è®¾å¤‡ä¸Šè¿è¡Œï¼Œæˆ–è€…ç›´æ¥ä¸‹è½½Docker[é•œåƒ](https://hub.docker.com/r/cloudflare/cloudflared)ç”¨å®¹å™¨è·‘ä¹Ÿè¡Œã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ OpenWrt çš„ç‰ˆæœ¬ã€‚

Cloudflare ä¸Šè¦åœ¨ä¸»é¡µå·¦ä¾§èœå•ç‚¹å‡»`Zero Trust`->`ç½‘ç»œ`->`è¿æ¥å™¨`ï¼Œåˆ›å»ºéš§é“ã€‚  
ç„¶åæ‹¿ç€`éš§é“ID`å’Œ`ä»¤ç‰Œ`ï¼Œå¡«å†™é…ç½®æ–‡ä»¶ï¼š

```yaml title="config.yaml"
# é…ç½®æ–‡ä»¶å‚æ•°ï¼š
# - https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/configure-tunnels/cloudflared-parameters/run-parameters/
# - https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/configure-tunnels/cloudflared-parameters/origin-parameters/
tunnel: Sub-Store
credentials-file: /root/.cloudflared/{éš§é“ID}.json
# edge-ip-version: "4"
# protocol: http2 # quic
metrics: 0.0.0.0:20241
loglevel: info
# æš´éœ²ç§ç½‘åˆ° CF çš„ç½‘ç»œä¸­(å’Œ tailscale çš„ subnet ä¸€ä¸ªæ„æ€ï¼Œå®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨ WARP å¹¶å¯ç”¨ zero trustï¼ŒåŒæ ·è¦å¼€ VPN)
warp-routing:
  enabled: false
ingress:
  - hostname: okk.happy.de5.net
    service: http://192.168.0.8:3001
  - service: http_status:404
```

å¦å¤–è¿˜éœ€è¦ä¸€ä¸ªè¯ä¹¦ï¼Œ[è®¿é—®](https://dash.cloudflare.com/argotunnel)ï¼Œé€‰æ‹©`happy.de5.net`è¿™ä¸ªåŸŸåï¼Œç‚¹å‡»ä¸‹è½½è¯ä¹¦`cert.pem`ã€‚

```yaml title="compose.yaml"
services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    environment:
      - TUNNEL_TOKEN={ä»¤ç‰Œ}
      - TUNNEL_ORIGIN_CERT=/etc/cloudflared/cert.pem
      - NO_AUTOUPDATE=true
    network_mode: host
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared
```

ç„¶ååœ¨å…¬ç½‘è®¿é—®`happy.de5.net`è¯·æ±‚å°±ä¼šåˆ°è¾¾å†…ç½‘çš„`http://192.168.0.8:3001`ã€‚

Cloudflare çš„ Tunnel ä½¿ç”¨å’Œ Tailscale çš„ Funnel ç±»ä¼¼ã€‚åŒºåˆ«åœ¨äº Funnel å¼ºåˆ¶èµ° derp ä¸­è½¬ä¼šå¾ˆæ…¢ï¼ŒTunnel ç½‘é€Ÿå°±å¾ˆå¥½ã€‚  
Cloudflare warp å’Œ Tailscale çš„ subnet åˆå¾ˆåƒï¼Œéƒ½æ˜¯å¯ä»¥æš´éœ²å­ç½‘ï¼Œåˆéƒ½éœ€è¦ä½¿ç”¨å„è‡ªçš„å®¢æˆ·ç«¯èµ·å¯ç”¨ VNP è®¿é—®ã€‚åŒºåˆ«åœ¨äº Cloudflare ä½¿ç”¨çš„ WARP åœ¨å›½å†…å·²ç»è¿ä¸ä¸Šäº†ï¼Œè€Œ Tailscale å®¢æˆ·ç«¯è¿˜èƒ½æ­£å¸¸ç”¨ï¼Œå®ƒçš„ subnet å¾ˆå¥½ç”¨ã€‚

## 6. æ€»ç»“

è‡³æ­¤ï¼Œä¸æ Tailscale æˆ‘ä»¬ä¸€å…±æœ‰ 5 ç§å†…ç½‘ç©¿é€çš„ä½¿ç”¨æ–¹å¼ï¼šå•ipv4(STUN)ã€å•ipv6(åŸç”Ÿ)ã€Tunnel(å…œåº•)ã€URLé‡å®šå‘ã€åŠ å¯†éš§é“(VPN)ï¼Œå…¶ä¸­æœ€åè¿™ç§æ–¹å¼åœ¨æœ¬æ–‡çš„å¼€å¤´æåˆ°çš„æ–‡ç« ä¸­æœ‰è¯¦è¯´ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

åŸºäºä½¿ç”¨åœºæ™¯åˆ’åˆ†ï¼š

1. ç½‘é¡µç«¯æµè§ˆï¼Œç”¨é‡å®šå‘æ–¹æ¡ˆã€‚
2. å¤§æµé‡ä¼ è¾“ï¼Œç”¨ VPN æ–¹æ¡ˆã€‚
3. api è°ƒç”¨ï¼Œç”¨ Worker åä»£æ–¹æ¡ˆã€‚

åä¸¤ç§æ–¹æ¡ˆç»“åˆèµ·æ¥ä½¿ç”¨ä½“éªŒæœ€ä¸æ»‘ï¼Œå…è´¹æ–¹æ¡ˆä¹Ÿæœ‰ä¸è¾“ä»˜è´¹çš„ä½“éªŒğŸ‰ã€‚

## è¡¥å……(2025/12/16)

å®é™…ä½¿ç”¨å‘ç°ä¸ªé—®é¢˜ï¼ŒWorker ä¸­è¯·æ±‚`sub.v4.happy.de5.net`å’Œ`sub.v6.happy.de5.net`æ€»æ˜¯ä¸èƒ½é€šï¼Œæœ€åéƒ½ä¼šé™çº§åˆ°`sub.happy.de5.net`ã€‚åæ¥å‘ç°ï¼Œä»æµ·å¤– ip è®¿é—®å›½å†… ip æ˜¯ä¼šè¢« GFW æ‹¦æˆªçš„ï¼Œping åŸŸåçš„æ—¶å€™åªæœ‰ç¬¬ä¸€æ¬¡å›å¤ï¼Œä¹‹åå°±é»‘æ´äº†ï¼Œä¸ä¼šå†å›å¤äº†ã€‚è€Œ Cloudflare çš„èŠ‚ç‚¹éƒ½æ˜¯åœ¨å¤§é™†åœ°åŒºä»¥å¤–çš„ï¼Œè¢«æ‹¦æˆªå°±æ˜¯æ­£å¸¸æƒ…å†µäº†ã€‚é™¤éæ˜¯ä»å›½å†… ip è®¿é—®ï¼Œä½†é‚£æ ·èŠ±é’±æ˜¯ä¸€å›äº‹ï¼Œè¿˜è¦å¤‡æ¡ˆå®åæ¯”è¾ƒéº»çƒ¦ã€‚  
å› æ­¤ï¼Œåªèƒ½æ”¹å˜ç­–ç•¥äº†ï¼ŒæŠŠå…³é”®çš„æœåŠ¡éƒ¨ç½²åœ¨å…¬ç½‘ä¸Šï¼Œæœ‰æŒºå¤š PaaS å‚å•†çš„æœåŠ¡å¯ä»¥é€‰æ‹©ï¼Œæ¯”å¦‚ï¼š[Zeabur](https://zeabur.com/)ã€[Leaflow](https://leaflow.net/)ã€[Koyeb](https://www.koyeb.com/)ç­‰ï¼Œå®ƒä»¬éƒ½æœ‰ç›¸å½“å¤šçš„å…è´¹é¢åº¦å¯ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œå°±ä»¥ Zeabur ä¸ºä¾‹æ¼”ç¤ºã€‚

å¯¹æˆ‘æ¥è®²ï¼Œå…³é”®çš„æœåŠ¡å°±æ˜¯`Sub-Store`ï¼Œå› æ­¤éœ€è¦åœ¨ Zeabur ä¸Šéƒ¨ç½²å®ƒï¼Œä½†å¯æƒœçš„æ˜¯æŒºå¤šå‚å•†å°æ€äº†[sub-store](https://hub.docker.com/r/xream/sub-store)é•œåƒã€‚ä½†ä¹Ÿæœ‰åº”å¯¹ç­–ç•¥ï¼Œé‚£å°±æ˜¯è‡ªå·±ç¼–è¯‘é•œåƒæ¢ä¸ªåã€‚

ä¸å¾—ä¸æä¸€å˜´ï¼Œå®˜æ–¹çš„[æ–‡æ¡£](https://hub.docker.com/r/xream/sub-store)å†™çš„æ¯”è¾ƒä¹±ï¼Œçœ‹èµ·æ¥æœ‰äº›è´¹è§£ã€‚å¹¶ä¸”å®˜æ–¹çš„[æ„å»ºæ–‡ä»¶](https://xream.notion.site/Sub-Store-Hugging-Face-1787ae7c38df482eaeccea4e0f1d3a8d)å†™çš„ä¹Ÿä¸å¥½çœ‹ã€‚å› æ­¤åœ¨é˜…è¯»æ–‡æ¡£â•å®è·µéªŒè¯è¿‡åï¼Œä¼˜åŒ–å‡ºæ¥å¦‚ä¸‹ç‰ˆæœ¬ï¼š

::: code-tree title="Sub-Store Project" height="600px" entry="Dockerfile"

```yaml title="Dockerfile" :active
FROM node:24-alpine3.21

WORKDIR /opt/app

RUN apk add --no-cache curl unzip tzdata ca-certificates && \
    cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone && \
    mkdir -p /opt/app/data

ENV SUB_STORE_FRONTEND_HOST=:: \
    SUB_STORE_FRONTEND_PORT=3000 \
    SUB_STORE_BACKEND_API_HOST=:: \
    SUB_STORE_BACKEND_API_PORT=3001 \
    SUB_STORE_BACKEND_MERGE=true \
    SUB_STORE_BODY_JSON_LIMIT=10mb \
    SUB_STORE_FRONTEND_BACKEND_PATH=/subark \
    SUB_STORE_BACKEND_PREFIX=true \
    SUB_STORE_FRONTEND_PATH=/opt/app/frontend \
    SUB_STORE_DATA_BASE_PATH=/opt/app/data \
    SUB_STORE_MMDB_COUNTRY_PATH=/opt/app/data/GeoLite2-Country.mmdb \
    SUB_STORE_MMDB_ASN_PATH=/opt/app/data/GeoLite2-ASN.mmdb

ARG CACHEBUST="1970-01-01 00:00:00"
ENV BUILD_TIME=${CACHEBUST}

RUN echo "Building at ${BUILD_TIME}..." && \
    curl -L "https://github.com/sub-store-org/Sub-Store/releases/latest/download/sub-store.bundle.js" -o /opt/app/sub-store.bundle.js && \
    curl -L "https://github.com/sub-store-org/Sub-Store-Front-End/releases/latest/download/dist.zip" -o dist.zip && \
    unzip dist.zip && \
    mv dist frontend && \
    rm dist.zip && \
    chmod 777 -R /opt/app

RUN echo '#!/bin/sh' > entrypoint.sh && \
    echo 'echo "Build time: $BUILD_TIME"' >> entrypoint.sh && \
    echo 'exec node /opt/app/sub-store.bundle.js' >> entrypoint.sh && \
    chmod +x entrypoint.sh

CMD ["./entrypoint.sh"]
```

```bash title="build.sh"
#!/bin/bash
docker buildx create --use # æ‰§è¡Œä¼šåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ‰€ä»¥æ‰§è¡Œä¸€æ¬¡å°±å¯ä»¥äº†
# æŒ‡å®šä¸€ä¸ªæ—¶åŒºï¼Œå¦åˆ™é»˜è®¤æ˜¯ UTC æ—¶é—´
docker buildx build \
  --platform linux/arm64,linux/amd64 \
  -f Dockerfile \
  --build-arg CACHEBUST="$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')" \
  -t {ä½ çš„ Docker Hub ç”¨æˆ·å:someone}/{ä½ çš„é¡¹ç›®åç§°:sube}:v4 \
  --push .
```

:::

åªéœ€è¦ä¸€é”®`./build.sh`å³å¯æ„å»ºå¹¶æ¨é€åˆ° DockerHubã€‚ç»å¤§å¤šæ•°ç¯å¢ƒå˜é‡å·²ç»é¢„å®šä¹‰äº†ï¼Œæ— éœ€è¿‡å¤šè®¾ç½®ã€‚  
æ­¤ç‰ˆç§»é™¤äº†`http-meta`åŠŸèƒ½ï¼Œå†…å­˜å ç”¨æš´é™ï¼Œæå¤§é™ä½äº† Zeabur ä¸Šçš„èŠ±è´¹ã€‚å¦å¤–æ¨èä½¿ç”¨ Gists å¤‡ä»½ï¼Œè¿™æ ·ä¹Ÿä¸ç”¨æŒ‚è½½ç›®å½•äº†ã€‚

Docker Compose éƒ¨ç½²å¦‚ä¸‹ï¼š

```yaml title="compose.yaml"
services:
  sube:
    name: sube
    image: someone/sube:latest
    ports: [3001:3001]
    volumes:
        - ./data:/opt/app/data
    environment:
        # é‡è¦ï¼šä¸€å®šè¦è®¾ç½®å¤æ‚çš„è·¯å¾„é˜²æ­¢è¢«æ‰«å¯¼è‡´æ³„éœ²èµ„æºä¿¡æ¯ï¼Œ/sube åªæ˜¯æ¼”ç¤ºå€¼
        - SUB_STORE_FRONTEND_BACKEND_PATH=/sube
```

Zeabur ä¸Šéœ€è¦æš´éœ²ç«¯å£`3001`ç±»å‹ä¸º`HTTP`ï¼Œå‡è®¾ç»™å®šçš„åŸŸåæ˜¯`sube.zeabur.app`ï¼Œåˆ™æµè§ˆå™¨åœ°å€æ è¾“å…¥`https://sube.zeabur.app?api=https://sube.zeabur.app/sube"`å¯ä¸€é”®è®¿é—®å‰åç«¯ã€‚

==å†æ¬¡å¼ºè°ƒ==ï¼šæ„å»ºè‡ªå·±çš„é•œåƒä½¿ç”¨ï¼Œåç§°è¶Šæ— å…³è¶Šå¥½ã€‚ä¸è¦å›¾æ–¹ä¾¿ç”¨åˆ«äººçš„ï¼Œå¦åˆ™ä¸€æ—¦åˆ«äººè¢«å°ï¼Œè‡ªå·±ä¹Ÿä¼šè¿åã€‚

---

::: note æœ¬æ–‡å‚è€ƒ

- [ä½¿ç”¨Cloudflareçš„é¡µé¢è§„åˆ™å›ºå®šå’Œéšè—ç½‘é¡µç«¯å£](https://ie12blog.36102025.xyz/articles/lucky-STUN/stun-web-serve-CF)
- [IPv4å’ŒIPv6åˆ†ç¦»é‡å®šå‘](https://ie12blog.36102025.xyz/articles/lucky-STUN/stun-v4-v6-redirect)
- [ä½¿ç”¨Cloudflareçš„é‡å®šå‘è§„åˆ™ä¼ é€’èµ„æºè·¯å¾„å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²](https://ie12blog.36102025.xyz/articles/lucky-STUN/stun-cf-redirection)
- [Lucky v2.15 ç‰ˆæœ¬åçš„DDNSé…ç½®æ–¹æ³•](https://ie12blog.36102025.xyz/articles/lucky-STUN/lucky-ddns-2.15)
- [LUCKY ç³»åˆ—](https://ie12blog.36102025.xyz/the-index/#lucky-%E7%B3%BB%E5%88%97)

:::