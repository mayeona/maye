---
title: æ„å»ºé•œåƒæ¨é€ç§æœ‰ä»“åº“
tags:
  - docker
createTime: 2025/12/03 06:04:45
permalink: /article/6emcwc0t/
---

## å‰è¨€

æœ¬åœ°å¼€å‘é¡¹ç›®ç»å¸¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œä¹‹åé‡æ–°æ„å»ºé•œåƒï¼Œç„¶åæ¨é€åˆ°é•œåƒä»“åº“ï¼Œæ¥ç€åœ¨éƒ¨ç½²æœºä¸Šé¢æ‹‰å–æ–°é•œåƒé‡å»ºå®¹å™¨ã€‚ä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹æ˜¯æ¨é€åˆ° DockerHub çš„ï¼Œæ¯æ¬¡èµ°å…¬ç½‘å®åœ¨æ˜¯æ²¡æœ‰å¿…è¦ï¼Œå› æ­¤åœ¨å†…ç½‘ä¸­éƒ¨ç½²ä¸€ä¸ªé•œåƒä»“åº“æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚

## 1. åå‘ä»£ç†

å› ä¸º docker é»˜è®¤æ˜¯ä¸ä¿¡ä»» http è¯·æ±‚çš„ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®è®©å®ƒä¿¡ä»»ï¼Œä½†æ˜¯æˆ‘çš„å†…ç½‘ç¯å¢ƒä¸‹å·²ç»æœ‰äº† Caddy åä»£æœåŠ¡ï¼Œå¹¶ä¸”ä¹Ÿæœ‰äº† https è¯ä¹¦ï¼Œæ‰€ä»¥å°±è§„èŒƒä¸€äº›ï¼Œåˆ†é…ä¸€ä¸ªå­åŸŸåç»™é•œåƒä»“åº“æœåŠ¡ï¼š`dcoker.mayee.example.com`ã€‚åä»£é…ç½®å¦‚ä¸‹(192.168.0.100:5000 ä¸ºé•œåƒä»“åº“çš„åœ°å€)ï¼š
```plain title="Caddyfile"
# åŸæœ‰é…ç½®ç•¥ ...
dcoker.mayee.example.com {
    # éƒ¨ç½²é•œåƒä»“åº“æœåŠ¡(Registry)çš„ ip å’Œ port
    reverse_proxy 192.168.0.100:5000 {
        # å…³é”®é…ç½®ï¼šä¼ é€’ Host å’Œ Proto å¤´
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
}
# åŸæœ‰é…ç½®ç•¥ ...
```
ç„¶åé‡å¯ Caddy å®¹å™¨ï¼Œä½¿é…ç½®ç”Ÿæ•ˆã€‚

## 2. éƒ¨ç½²é•œåƒä»“åº“

ç”±äºæˆ‘çš„éœ€æ±‚æ˜¯çº¯å†…ç½‘ç¯å¢ƒä¸‹ï¼Œå› æ­¤ä¸è€ƒè™‘å®‰å…¨å’Œé‰´æƒçš„é—®é¢˜ï¼Œç®€å•ä½¿ç”¨å³å¯ã€‚æ‰€ä»¥é€‰æ‹©äº†[registry](https://hub.docker.com/_/registry)å’Œç›¸åº”çš„ UI æœåŠ¡[docker-registry-ui](https://hub.docker.com/r/joxit/docker-registry-ui)ã€‚

```yaml title="compose.yaml"
version: '3'

services:
  registry:
    image: registry:latest
    container_name: registry
    restart: always
    ports:
      - "5000:5000"
    environment:
      # ====== åŸºç¡€é…ç½® ======
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      REGISTRY_HTTP_SECRET: "mayee"
      # ====== æ—¥å¿—ä¸ç›‘æ§ä¼˜åŒ– ======
      OTEL_TRACES_EXPORTER: "none"
      REGISTRY_LOG_LEVEL: "warn"
      # ====== âš ï¸ CORS è·¨åŸŸé…ç½® (UI å¿…é¡») ======
      # å…è®¸æ‰€æœ‰åŸŸåè®¿é—® (å†…ç½‘ç¯å¢ƒä¸ºäº†æ–¹ä¾¿ç›´æ¥å¼€ *)
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: "['*']"
      # å…è®¸çš„æ–¹æ³•
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: "['HEAD', 'GET', 'OPTIONS', 'DELETE']"
      # å…è®¸çš„ Header
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Headers: "['Authorization', 'Accept', 'Cache-Control']"
      # å…è®¸å‰ç«¯è¯»å–çš„ Header (æ¯”å¦‚è¯»å– Docker çš„ Digest)
      REGISTRY_HTTP_HEADERS_Access-Control-Expose-Headers: "['Docker-Content-Digest']"

    volumes:
      - ./data:/var/lib/registry

  registry-ui:
    image: joxit/docker-registry-ui:main
    container_name: registry-ui
    restart: always
    ports:
      - "15000:80"
    environment:
      - REGISTRY_URL=https://dcoker.mayee.example.com
      - REGISTRY_TITLE=Mayee Registry
      - DELETE_IMAGES=true
      - SINGLE_REGISTRY=true
    depends_on:
      - registry
```

è¿è¡Œèµ·æ¥å³å¯ï¼Œè®¿é—®éƒ¨ç½²æœº`http://192.168.0.100:15000`å³å¯çœ‹åˆ° ui é¡µé¢ã€‚

è¿™é‡Œæˆ‘ä»¬å…è®¸é€šè¿‡é¡µé¢åˆ é™¤é•œåƒï¼Œä½†æ˜¯ Docker Registry çš„ä¸€ä¸ªç»å…¸æœºåˆ¶ï¼šUI ä¸Šç‚¹å‡»åˆ é™¤ï¼Œåªæ˜¯åˆ é™¤äº†â€œå¼•ç”¨â€ï¼ˆTag å’Œ Manifestï¼‰ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºåˆ é™¤äº†æ–‡ä»¶çš„â€œå¿«æ·æ–¹å¼â€ï¼Œä½†å®é™…çš„æ•°æ®å—ï¼ˆBlobs/Layersï¼‰ä¾ç„¶èººåœ¨ç¡¬ç›˜é‡Œå ç”¨ç©ºé—´ã€‚Docker å®˜æ–¹è¿™æ ·è®¾è®¡æ˜¯ä¸ºäº†é˜²æ­¢å¹¶å‘è¯»å†™æ—¶çš„å†²çªï¼Œä½†å¯¹äºæˆ‘ä»¬ä¸ªäºº NAS æ¥è¯´ï¼Œè¿™å°±æ˜¯å•çº¯çš„â€œå ç€èŒ…å‘ä¸æ‹‰å±â€ï¼Œæ‰€ä»¥å¾—â€œåŠäº†å®ƒâ€ã€‚

å¯ä»¥ç›´æ¥æ‰‹åŠ¨æ‰§è¡Œ`docker exec -i registry bin/registry garbage-collect --delete-untagged /etc/docker/registry/config.yml`ï¼Œå¦‚æœæç¤º`/etc/docker/registry/config.yml`æ–‡ä»¶æ‰¾ä¸åˆ°ï¼Œå¯ä»¥ç”¨`docker exec -it registry find / -name "config.yml"`å‘½ä»¤æ‰¾å‡ºæ–‡ä»¶çš„ä½ç½®ã€‚ä¾‹å¦‚æˆ‘çš„æ–‡ä»¶çœŸå®ä½ç½®åœ¨`/etc/distribution/config.yml`ï¼Œæ›¿æ¢ä¸ºçœŸå®æ–‡ä»¶ä½ç½®åå†æ¬¡æ‰§è¡Œã€‚

ä½†æ€»æ˜¯æ‰‹åŠ¨æ‰§è¡Œæ˜¯éº»çƒ¦çš„ï¼Œå¯ä»¥ç”¨å®šæ—¶ä»»åŠ¡æ¥æ‰§è¡Œã€‚è€Œæœ‰çš„ç³»ç»Ÿï¼Œä¾‹å¦‚ï¼šé£ç‰›(FnOS)ã€‚å®ƒå®‰è£…çš„ docker ä¸æ˜¯ root ç”¨æˆ·ç»„çš„ï¼Œå¯¼è‡´åœ¨æ™®é€šç”¨æˆ·ä¸‹æ‰§è¡Œ docker å‘½ä»¤éœ€è¦åŠ  sudoã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ docker åŠ å…¥åˆ° root ç»„ï¼Œä½†æ˜¯ä¸ºäº†ä¸ç ´åç³»ç»ŸåŸæœ¬çš„è®¾è®¡ç”¨æ„ï¼Œè¿˜æ˜¯é€‰æ‹©ä»¥ root èº«ä»½æ¥å®šæ—¶æ‰§è¡Œè„šæœ¬ã€‚

1. åˆ‡æ¢åˆ° root ç”¨æˆ·`sudo -i`ã€‚
2. åˆ›å»ºä»»åŠ¡è„šæœ¬`/root/docker-gc.sh`ã€‚
```bash title="docker-gc.sh"
#!/bin/bash
echo "=========================================="
echo "Starting Docker Registry GC at $(date)"
# 1. æ‰§è¡Œåƒåœ¾å›æ”¶
# --delete-untagged: æ¸…ç†æœªè¢«æ ‡ç­¾å¼•ç”¨çš„å­¤å„¿å±‚ï¼ˆæ…ç”¨ï¼Œä½†åœ¨ä¸ªäººå¼€å‘ç¯å¢ƒé€šå¸¸å¾ˆæœ‰ç”¨ï¼‰
/usr/bin/docker exec -i registry bin/registry garbage-collect --delete-untagged /etc/distribution/config.yml
# 2. (å¯é€‰) é‡å¯ Registry å®¹å™¨
# æŸäº›ç‰ˆæœ¬çš„ Registry åœ¨ GC åå¦‚æœä¸é‡å¯ï¼Œç»Ÿè®¡æ•°æ®å¯èƒ½ä¸æ›´æ–°ï¼Œæˆ–è€…ä¸é‡Šæ”¾æ–‡ä»¶å¥æŸ„
/usr/bin/docker restart registry
echo "Finished Docker Registry at $(date)"
echo "=========================================="
```
3. èµ‹äºˆæ‰§è¡Œæƒé™`chmod +x /root/docker-gc.sh`ã€‚
4. åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ‰§è¡Œ`crontab -e`ä¼šæ‰“å¼€å®šæ—¶ä»»åŠ¡çš„ nano ç¼–è¾‘å™¨ï¼Œåœ¨æ–°çš„ä¸€è¡Œæ·»åŠ `0 4 * * 1 /bin/bash /root/docker-gc.sh >> /var/log/registry-gc.log 2>&1ï¼Œå°±ä¼šåœ¨`æ¯å‘¨ä¸€çš„å‡Œæ™¨ 4:00 æ•´æ‰§è¡Œä¸€æ¬¡`ï¼Œå¦‚æœæ¨é€åˆ°æ¯”è¾ƒé¢‘ç¹ï¼Œå¯ä»¥è°ƒå°æ‰§è¡Œå‘¨æœŸã€‚ä¹‹åæŒ‰ä¸‹`ctrl+x`å’Œ`y`ä¿å­˜å³å¯ã€‚
5. é€€å‡º root ç”¨æˆ·`exitã€‚

è¿™æ ·ä¸€æ¥ï¼Œå½“é€šè¿‡ ui é¡µé¢åˆ é™¤äº†é•œåƒï¼Œé‚£äº›é•œåƒå°±æˆäº†æ²¡æœ‰æ ‡ç­¾çš„å­¤å„¿å±‚ï¼Œä¹‹åè„šæœ¬è§¦å‘æ—¶ä¼šæ‰«æåˆ°è¿™äº›é•œåƒï¼Œç„¶åä»ç¡¬ç›˜ä¸ŠçœŸæ­£åˆ é™¤ã€‚

## 3. å¼€å‘ä¸­ä½¿ç”¨

ç”±äº docker çš„ç½‘ç«™è¢«å¢™äº†ï¼Œé€šå¸¸éœ€è¦é…ç½®å›½å†…é•œåƒæºã€‚å¼€å‘æœºä¸Šå¯ä»¥ç¼–è¾‘`/etc/docker/daemon.json`ï¼ŒåŠ ä¸Šé•œåƒæºåœ°å€ï¼Œä¿å­˜åé‡å¯ docker `sudo systemctl restart docker`ã€‚å¼€å‘æ„å»ºé•œåƒæ—¶ï¼Œä¸ºäº†æ„å»ºå¤šå¹³å°é•œåƒä¼šä½¿ç”¨`buildx`ï¼Œä½† buildx æ„å»ºè¿‡ç¨‹æ˜¯åœ¨ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨é‡Œè¿›è¡Œçš„ï¼Œå®ƒé»˜è®¤ä¸è¯»å–å®¿ä¸»æœºçš„`daemon.json`ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—ç»™å®ƒä¸€ä¸ªé…ç½®ç”¨ï¼Œé…ç½®å¥½å›½å†…é•œåƒæºã€‚

1. åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶`buildkitd.toml`ã€‚
```toml title="buildkitd.toml"
debug = false

[registry."docker.io"]
  # å›½å†…é•œåƒæºï¼Œæˆ–è€…ä½ çš„é˜¿é‡Œäº‘åŠ é€Ÿåœ°å€
  mirrors = ["https://docker.m.daocloud.io", "https://dockerproxy.net"]

[registry."dcoker.mayee.example.com"]
  http = false
  insecure = false
```
2. é•œåƒæ„å»ºè„šæœ¬`docker.sh`ï¼Œä¸€æ¬¡æ€§æ¨é€åˆ°å…¬æœ‰åˆç§æœ‰ä»“åº“ï¼Œä¹Ÿå¯ä»¥å»æ‰æ¨é€å…¬æœ‰ä»“åº“ï¼Œåªæ¨ç§ä»“ã€‚
```bash title="docker.sh"
#!/bin/bash
set -e

echo "ğŸ”¨ [1/2] æ„å»º Jar åŒ… ..."
# maven ç¦»çº¿æ¨¡å¼æ‰“åŒ…ï¼Œè·³è¿‡æµ‹è¯•
./mvnw clean package -o -DskipTests
if [ $? -ne 0 ]; then echo "âŒ æ„å»º Jar åŒ…å¤±è´¥"; exit 1; fi

echo "ğŸ³ [2/2] æ„å»º Docker é•œåƒ ..."
# ç¡®ä¿åˆ›å»ºäº† buildx å®ä¾‹ (åªéœ€è¿è¡Œä¸€æ¬¡ï¼Œå¦‚æœå·²å­˜åœ¨ä¼šè·³è¿‡)
docker buildx create --name builderx --use --driver docker-container --config buildkitd.toml 2>/dev/null || true
docker buildx inspect --bootstrap
# Buildx ç‰¹æ€§ï¼Œæ‰“å¤šæ¶æ„é•œåƒå¿…é¡»ç›´æ¥ push åˆ°ä»“åº“ï¼Œä¸èƒ½ä¿å­˜åœ¨æœ¬åœ° images åˆ—è¡¨
docker buildx build \
    --platform linux/arm64,linux/amd64 \
    -f Dockerfile \
    -t dcoker.mayee.example.com/mayeee/homebox:2.0.0 \
    -t dcoker.mayee.example.com/mayeee/homebox:latest \
    -t mayeee/homebox:2.0.0 \
    -t mayeee/homebox:latest \
    --push .
```
3. Dockerfile ç¤ºä¾‹ã€‚
```plain
FROM eclipse-temurin:25-jre-alpine
# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache fping openssh-client openssl tzdata
# åˆ›å»ºè¿è¡Œç›®å½•
WORKDIR /app
# ä» builder é•œåƒæ‹·è´ jar
COPY target/homebox.jar ./homebox.jar
# æš´éœ²ç«¯å£
EXPOSE 8000
# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["java", "-jar", "homebox.jar"]
```

å¦‚æ­¤ï¼Œå³å¯å®ç°çº¯å†…ç½‘ç¯å¢ƒä¸‹å¼€å‘å’Œéƒ¨ç½²ç§æœ‰é¡¹ç›®ï¼Œå¹¶ä¸”ç”¨å›½å†…é•œåƒæºæ— ç½‘ç»œé—®é¢˜å¹²æ‰°ã€‚