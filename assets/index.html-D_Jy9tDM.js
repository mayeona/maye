import{_ as t,c as h,b as n,a,e as i,d as l,w as p,r as k,o as d}from"./app-B_sKV6fk.js";const r={};function g(c,s){const e=k("VPLink");return d(),h("div",null,[s[9]||(s[9]=n(`<h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>之前在 R2S 上安装了 SVN 作为代码仓库，虽然它装起来简单，但是它管理起来不太方便。还是觉得装个 Git 仓库合适，刚好<a href="https://gogs.io/" target="_blank" rel="noopener noreferrer">Gogs</a>就很不错，安装也简单。不过再继续用 ip 访问显得不优雅，索性也用 Caddy 反代服务。</p><h2 id="_1-安装-gogs" tabindex="-1"><a class="header-anchor" href="#_1-安装-gogs"><span>1. 安装 Gogs</span></a></h2><p>Gogs 的安装很简单，一开始下载二进制包，解压后在 OpenWrt 上运行不起来，于是选择通过 <a href="https://hub.docker.com/r/gogs/gogs" target="_blank" rel="noopener noreferrer">Docker 安装</a>：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> volume</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gogs-data</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name=gogs</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 9522:22</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 9530:3000</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -v</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gogs-data:/data</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> RUN_CROND=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> BACKUP_INTERVAL=1d</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> BACKUP_RETENTION=7d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gogs/gogs</span></span></code></pre></div><p>至此，Gogs 就安装好了，这里启用了定时(RUN_CROND)系统备份，备份频率(BACKUP_INTERVAL)为每 1 天，保留备份数(BACKUP_RETENTION)为 7 天，即 7 天前的备份会自动删除，备份文件存放(BACKUP_ARG_CONFIG)在<code>~/gogs/backup</code>目录下，我们稍后来配置它。</p><h2 id="_2-修改-uhttpd-端口" tabindex="-1"><a class="header-anchor" href="#_2-修改-uhttpd-端口"><span>2. 修改 uhttpd 端口</span></a></h2><p>OpenWrt 使用 uhttpd 运行 http 服务，默认端口为 80，但 Caddy 的端口也是 80，所以这里先将 uhttpd 端口改为 8080，稍后再用 Caddy 反代过来。</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark has-focused-lines vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 其他代码已省略...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> uhttpd</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">main</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line has-focus"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        list</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> listen_http</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">0.0.0.0:8080</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line has-focus"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        list</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> listen_http</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[::]:8080</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #list listen_https &#39;0.0.0.0:443&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        #list listen_https &#39;[::]:443&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 其他代码已省略...</span></span></code></pre></div><p>重启 uhttpd 服务<code>service uhttpd restart</code>，如果没效果就直接重启 OpenWrt 系统，之后通过<code>http://192.168.0.1:8080</code>能访问通就没错了。</p><h2 id="_3-安装-caddy" tabindex="-1"><a class="header-anchor" href="#_3-安装-caddy"><span>3. 安装 Caddy</span></a></h2><p>Caddy 支持通过 Dcoker 安装，不过 OpenWrt 支持运行 Caddy 的二进制包。通过 Caddy 的<a href="https://caddyserver.com/download" target="_blank" rel="noopener noreferrer">下载服务器</a>选择<code>Linux arm64</code>版本，因为我的 R2S CPU 架构是 aarch64，所以选择这个版本。</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 先创建目录(因为压缩包内没有目录，解压出来就平铺当前目录了)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> caddy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -zxf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> caddy_2.10.0_linux_arm64.tar.gz</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -C</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> caddy</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制过去就行了，默认有执行权限</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> caddy/caddy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/bin/</span></span></code></pre></div><p>编写配置模板<code>Caddyfile</code>(名称随意)：</p><div class="language-text" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>mc.lan {</span></span>
<span class="line"><span>        tls internal</span></span>
<span class="line"><span>        reverse_proxy 127.0.0.1:8080</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>gogs.mc.lan {</span></span>
<span class="line"><span>        tls internal</span></span>
<span class="line"><span>        reverse_proxy 127.0.0.1:9530</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>这里将<code>mc.lan</code>域名反代到了<code>127.0.0.1:8080</code>(OpenWrt)，<code>gogs.mc.lan</code>反代到了<code>127.0.0.1:9530</code>(Gogs)。然后执行:</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 格式化配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./usr/bin/caddy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fmt</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --overwrite</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ~/Caddyfile</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 转换为 json 文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./usr/bin/caddy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> adapt</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ~/Caddyfile</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/config/caddy</span></span></code></pre></div><p>编写启动配置<code>/etc/init.d/caddy</code>：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/bin/sh /etc/rc.common</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">START</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">99</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">USE_PROCD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">1</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">LOGFILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/var/log/caddy.log</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">start_service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    procd_open_instance</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    procd_set_param</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> command</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/bin/caddy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/config/caddy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    procd_set_param</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stdout</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">$LOGFILE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    procd_set_param</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stderr</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">$LOGFILE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    procd_set_param</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> respawn</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    procd_close_instance</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre></div><p>运行开机启动<code>service caddy enable</code>，启动服务<code>service caddy start</code>，会自动在<code>/.local/share/caddy/certificates/local</code>目录下生成站点证书。至此，Caddy 就安装好了。</p><h2 id="_4-配置-gogs" tabindex="-1"><a class="header-anchor" href="#_4-配置-gogs"><span>4. 配置 Gogs</span></a></h2><p>访问<code>https://gogs.mc.lan</code>，此时浏览器会提示不安全忽略即可。接着浏览器会自动重定向到 Gogs 的配置页面，参考<a href="https://hub.docker.com/r/gogs/gogs" target="_blank" rel="noopener noreferrer">Gogs安装</a>的<code>Settgins</code>一节做如下配置(只说需要改动的项，其他保持默认)：</p><table><thead><tr><th style="text-align:center;">配置项</th><th style="text-align:center;">值</th></tr></thead><tbody><tr><td style="text-align:center;">数据库</td><td style="text-align:center;">SQLite3</td></tr><tr><td style="text-align:center;">域名</td><td style="text-align:center;">gogs.mc.lan</td></tr><tr><td style="text-align:center;">SSH端口</td><td style="text-align:center;">9522</td></tr><tr><td style="text-align:center;">应用URL</td><td style="text-align:center;">https://gogs.mc.lan</td></tr></tbody></table><p>然后安装即可，第一个注册的用户自动成为管理员。<br> 所有的配置可以在 Docker Vomule 下查看，由于我将<code>/opt/docker</code>挂载为了 Docker 根目录，因此 Gogs 的配置文件在<code>/opt/docker/volumes/gogs-data/_data/gogs/conf/app.ini</code>。可配置项参考<a href="https://github.com/gogs/gogs/blob/main/conf/app.ini" target="_blank" rel="noopener noreferrer">app.ini</a>。</p><h2 id="_5-导出根证书" tabindex="-1"><a class="header-anchor" href="#_5-导出根证书"><span>5. 导出根证书</span></a></h2>`,25)),a("p",null,[s[1]||(s[1]=i("Caddy 自动生成的根证书在",-1)),s[2]||(s[2]=a("code",null,"/.local/share/caddy/pki/authorities/local/",-1)),s[3]||(s[3]=i("目录下，也可以通过命令",-1)),s[4]||(s[4]=a("code",null,'find / -type f -name "root.crt"',-1)),s[5]||(s[5]=i("来查找。接着将",-1)),s[6]||(s[6]=a("code",null,"root.crt",-1)),s[7]||(s[7]=i("复制出来导入到其他设备中信任即可，可参考",-1)),l(e,{href:"/article/7uov7swb/#_3-4-3-caddy-%E6%8E%A8%E8%8D%90"},{default:p(()=>[...s[0]||(s[0]=[i("远程开发实践 - Caddy",-1)])]),_:1}),s[8]||(s[8]=i("一节。之后再访问域名就没有不安全的提示了。",-1))]),s[10]||(s[10]=n(`<h2 id="_6-配置-ssh-密钥" tabindex="-1"><a class="header-anchor" href="#_6-配置-ssh-密钥"><span>6. 配置 SSH 密钥</span></a></h2><p>访问<code>https://gogs.mc.lan/user/settings/ssh</code>，在<code>SSH密钥</code>一栏中增加下面生成的公钥：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成密钥并保存在一个特定的位置，如：~/.ssh/Gogs/mayee/id_ed25519</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ssh-keygen</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ed25519</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -C</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">devos</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 将公钥配置在 gogs 中</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ~/.ssh/Gogs/mayee/id_ed25519.pub</span></span></code></pre></div><p>之后在<code>~/.ssh/config</code>中增加如下内容：</p><div class="code-block-title" data-title="config"><div class="code-block-title-bar"><span class="title">config</span></div><div class="language-bash" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Gogs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Host</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gogs.mc.lan</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    User</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> git</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    IdentityFile</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ~/.ssh/Gogs/mayee/id_ed25519</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    Port</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9522</span></span></code></pre></div></div><p>检查配置<code>ssh -T git@gogs.mc.lan</code>看到 <mark>Hi there, You&#39;ve successfully authenticated, but Gogs does not provide shell access.</mark> 即表示配置成功。</p>`,6))])}const y=t(r,[["render",g]]),A=JSON.parse('{"path":"/article/7dobd88o/","title":"Caddy反代gogs","lang":"zh-CN","frontmatter":{"title":"Caddy反代gogs","tags":["gogs"],"createTime":"2025/06/22 06:33:17","permalink":"/article/7dobd88o/"},"readingTime":{"minutes":3.37,"words":1012},"git":{"createdTime":1769985102000,"updatedTime":1769985102000,"contributors":[{"name":"Mayee","username":"Mayee","email":"may675154357@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/Mayee?v=4","url":"https://github.com/Mayee"}]},"filePathRelative":"blog/5.运维/5.Caddy反代gogs.md","headers":[],"categoryList":[{"id":"190c84","sort":5,"name":"运维"}]}');export{y as comp,A as data};
